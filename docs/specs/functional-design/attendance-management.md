# 기능 설계: 출석 관리

> PRD를 기반으로 구체적인 기능 흐름과 인터페이스를 정의합니다.

## 연결 문서

- PRD: `docs/specs/prd/school-attendance.md`
- 사업 문서: `docs/business/6_roadmap/roadmap.md`

## 기능 범위

| 기능 | 설명 | 상태 |
|------|------|------|
| 기본 출석 관리 | 테이블 뷰, 일괄 저장 | 구현 완료 |
| 자동 저장 (로드맵 1단계) | 셀 변경 즉시 저장 | 구현 완료 |
| 달력 UI (로드맵 1단계) | 달력 형태, 모달 입력, 의무축일 표시 | 구현 완료 |

## 흐름/상태

### 사용자 플로우

1. 그룹 선택하여 출석 현황 화면 진입
2. 연도별 출석 캘린더(토요일/일요일)와 학생별 출석 현황 조회
3. 해당 날짜의 출석 상태 입력 (◎/○/△ 등)
4. 자동 저장 또는 일괄 저장으로 변경 사항 반영

### 상태 전이

```
[출석 조회] → (출석 입력) → [자동 저장] → [출석 조회]
[출석 조회] → (저장 버튼) → [전체 동기화] → [출석 조회]
[출석 조회] → (출석 삭제) → [삭제 완료] → [출석 조회]
```

## UI/UX

### 화면/컴포넌트

| 화면 | 설명 | 주요 요소 |
|------|------|----------|
| 출석 현황 (테이블) | 그룹별 출석 테이블 | 연도 선택, 학생 목록 (세로), 날짜 (가로), 출석 입력 셀 |
| 출석 달력 | 월별 달력 뷰 | 그룹/월 선택, 날짜별 출석 현황, 의무축일 표시 |
| 출석 입력 모달 | 날짜별 학생 출석 체크 | 미사/교리 체크박스, 자동 상태 계산, 즉시 저장 |

### 권한별 차이

| 권한 | 접근 가능 기능 |
|------|---------------|
| 인증된 사용자 | 본인 계정 그룹의 출석 조회/입력/삭제 |

## 데이터/도메인 변경

### Attendance 테이블

| 필드 | 타입 | 설명 |
|------|------|------|
| _id | bigint (PK) | 출석 고유 식별자 |
| date | varchar(50) | 출석일 (YYYYMMDD 형식) |
| content | varchar(50) | 출석 내용 (◎/○/△ 등) |
| student_id | bigint (FK) | 학생 ID |
| create_at | datetime | 생성일시 |
| update_at | datetime | 수정일시 |
| delete_at | datetime | 삭제일시 |

마이그레이션: 없음 (기존 스키마 유지)

## API/인터페이스

### tRPC 프로시저

| 프로시저 | 타입 | 설명 |
|----------|------|------|
| `group.attendance` | query | 그룹 출석 현황 조회 (테이블 뷰용) |
| `attendance.update` | mutation | 출석 입력/삭제 (자동 저장 + 일괄 저장 겸용) |
| `attendance.calendar` | query | 월별 달력 데이터 (출석 현황 + 의무축일) |
| `attendance.dayDetail` | query | 날짜별 출석 상세 (모달용) |

### 주요 필드

| 프로시저 | 요청 필드 | 응답 필드 |
|----------|----------|----------|
| `group.attendance` | groupId(number), year(number) | year, sunday/saturday(날짜 배열), students(array), attendances(array) |
| `attendance.update` | year(number), attendance(array: _id, month, day, data), isFull(boolean) | row(number), isFull |
| `attendance.calendar` | year(number), month(number), groupId(number) | year, month, totalStudents, days(array: date, dayOfWeek, attendance, holyday) |

### 저장 방식

- **자동 저장** (셀 변경 시): `isFull=false`, 개별 출석 1건 즉시 전송
- **명시적 저장** (버튼 클릭): `isFull=true`, 전체 데이터 동기화

## 비즈니스 로직

| 기능 | 동작 요약 |
|------|----------|
| 출석 조회 | groupId + year → 주일/토요일 날짜 + 학생 + 출석 데이터 반환 |
| 출석 입력 (isFull=true) | 각 항목의 date(YYYYMMDD)로 기존 레코드 확인 → 없으면 생성, 있으면 업데이트 |
| 출석 삭제 (isFull=false, data 빈 값) | 해당 date 레코드 존재 시 물리 삭제 |
| 출석 상태 계산 | 미사+교리=◎, 미사만=○, 교리만=△, 둘 다 없음=- |
| 달력 데이터 | year + month + groupId → 일별 출석 현황(present/total) + 의무축일 |
| 부활 대축일 계산 | Anonymous Gregorian Algorithm으로 연도별 부활일 계산 |

## 자동 저장 (로드맵 1단계)

### 동작 방식

- 출석 셀 변경 시 즉시 서버에 개별 저장 (debounce 없음)
- 저장 상태 인디케이터: 저장 중(스피너), 완료(체크 2초), 오류(재시도 버튼)
- 저장 버튼 유지: 전체 동기화 + 심리적 안정감

### 그룹 전환 시

- 변경사항은 즉시 저장되므로 그룹 전환 시 별도 처리 불필요

### 오류 처리

- 네트워크 오류 시 오류 상태 표시 + 재시도 버튼
- 동시 편집 충돌: Last Write Wins (현재 정책 유지)

## 달력 UI (로드맵 1단계)

### 사용자 플로우

1. 그룹 선택 → 달력에서 월별 출석 현황 확인
2. 날짜 클릭 → 출석 입력 모달 오픈
3. 미사/교리 체크박스 체크 → 즉시 저장
4. 모달 닫기 → 달력에 반영

### 달력 날짜 셀

| 요소 | 표시 내용 |
|------|----------|
| 날짜 | 1, 2, 3, ... |
| 출석 현황 | 출석 N명 / 전체 M명 |
| 의무축일 | 빨간색 배경 또는 아이콘 |

### 출석 체크 방식

| 학생 | 미사 | 교리 | 결과 |
|------|------|------|------|
| 홍길동 | ✓ | ✓ | ◎ (출석) |
| 김철수 | ✓ | | ○ (미사만) |
| 박영희 | | ✓ | △ (교리만) |
| 이민수 | | | 결석 |

### 의무축일

**고정 축일:**
천주의 성모 마리아(1/1), 성모 승천(8/15), 모든 성인(11/1), 한국 성직자·수도자·신자들의 축일(9월 둘째 주일), 성탄(12/25)

**이동 축일 (부활 기준):**
부활, 예수 승천(+40일), 성령 강림(+50일), 삼위일체(성령 강림 후 첫 주일), 성체 성혈(삼위일체 후 목요일/주일), 예수 성심(성체 성혈 후 금요일), 그리스도 왕(대림 제1주일 전 주일)

## 삭제 정책

| 엔티티 | 삭제 방식 | 이유 |
|--------|----------|------|
| Group | 소프트 삭제 | 이력 보존, 복구 가능 |
| Student | 소프트 삭제 | 이력 보존, 복구 가능 |
| **Attendance** | **물리 삭제** | 개별 레코드 복구 필요성 낮음 |

## 권한/보안

- 모든 출석 API: Bearer 토큰 필수

## 예외/엣지 케이스

| 상황 | 처리 방법 |
|------|----------|
| 잘못된 groupId | 400 BAD_REQUEST |
| attendance 배열 누락 | 400 BAD_REQUEST |
| isFull 누락 | 400 BAD_REQUEST |
| year 누락/비정상 | 현재 연도로 대체 |
| 토큰 누락 | 401 UNAUTHORIZED |
| 네트워크 오류 (자동 저장) | 오류 인디케이터 + 재시도 |
| 주일 아닌 날짜 클릭 | 출석 입력 허용 (행사 등) |
| 의무축일 계산 오류 | 고정 축일만 표시, 로그 기록 |

## 성능/제약

- 그룹당 학생 수십 명 × 연간 50~100회 출석
- 일괄 처리로 다수의 출석 레코드 동시 처리

## 의사결정

| 항목 | 결정 | 비고 |
|------|------|------|
| 저장 방식 | 즉시 저장 (debounce 없음) | |
| 저장 버튼 | 유지 | 전체 동기화 + 심리적 안정감 |
| 오프라인 대응 | 미지원 | 1단계 스코프 외 |
| 출석 체크 방식 | 체크박스 목록 (미사/교리) | ◎○△ 표기 |
| 행사 관리 | 후순위 (3단계) | 의무축일만 1단계 구현 |

## 테스트 시나리오

### 정상 케이스

1. 그룹 출석 조회 → year, students, attendances 반환
2. 출석 일괄 입력 (isFull=true) → row 수 반환
3. 출석 삭제 (isFull=false) → row 수 반환
4. 달력 월별 데이터 → 일별 출석 현황 + 축일 반환
5. 출석 모달에서 체크 → 즉시 저장

### 예외 케이스

1. attendance 배열 누락 → 400
2. isFull 누락 → 400
3. 토큰 없이 호출 → 401

---

**작성일**: 2026-01-13 (기본), 2026-01-14 (자동 저장/달력 UI 병합)
**수정일**: 2026-02-12 (문서 축약 - 동작 명세 수준으로 정리)
**작성자**: PM 에이전트
**상태**: Approved (구현 완료)

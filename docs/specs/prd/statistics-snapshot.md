# PRD: 통계 스냅샷

> SDD 작성자가 작성하는 제품 요구사항 문서입니다.
> 사업 에이전트의 `docs/business/` 문서를 기반으로 작성합니다.

## 배경/문제 요약

- 참고: `docs/business/6_roadmap/roadmap.md` (2단계), `docs/business/STATUS.md`
- 문제: 과거 연도(2024, 2025년 등) 통계가 부정확하거나 조회 불가
- 현재 상태:
  - 통계가 **현재 학생/그룹 상태 기준**으로 라이브 계산됨
  - 졸업 학생(`graduatedAt != null`)이 통계에서 제외됨 → 과거 출석 데이터 소실
  - 학년 전환 스케줄러로 `groupId`가 변경됨 → 과거 그룹 배치 정보 소실
  - 학생 수(분모)가 현재 기준으로 계산됨 → 과거 출석률 왜곡
  - 학생 정보(이름, 세례명, 성별) 변경 시 과거 통계에도 현재 값이 반영됨 → 해당 시점 상태와 불일치
- 목표 상태: Student/Group **엔티티 변경 시 스냅샷을 별도 저장**하고, Attendance에는 `groupId`만 추가하여 과거 어떤 연도든 해당 시점 기준의 정확한 통계 조회 가능

## 목표/성공 기준

- **목표**: 엔티티 변경 이력(스냅샷) 기반으로 과거 연도 통계를 정확하게 조회할 수 있는 시스템
- **성공 지표**:
  - 2024년 통계 조회 시 2024년 당시의 그룹 구성·학생 정보가 반영됨
  - 졸업 학생의 과거 출석 데이터가 해당 연도 통계에 정상 포함
  - 기존 데이터(장위동 2022~현재) 마이그레이션 완료
- **측정 기간**: 배포 즉시 확인 가능 (과거 데이터 조회로 검증)

## 사용자/대상

- **주요 사용자**: 교리교사 (통계 조회, 사제 보고)
- **사용 맥락**: 연말 보고, 시상 대상 선정, 과거 연도 비교 확인

## 범위

### 포함

- StudentSnapshot 테이블: Student 변경 시 해당 시점 상태 저장 (societyName, catholicName, gender, groupId)
- GroupSnapshot 테이블: Group 변경 시 해당 시점 상태 저장 (name)
- Attendance 테이블에 `groupId` 추가 (출석 시점의 그룹 연결)
- 통계 쿼리를 스냅샷 기반으로 전환
- 졸업 학생의 과거 통계 포함
- 기존 데이터 마이그레이션 (현재 Student/Group 상태를 초기 스냅샷으로 생성 + Attendance에 groupId 역보정)
- 출석률 분모(학생 수) 계산을 해당 시점 기준으로 변경

### 제외

- 다중 연도 비교 통계 (차후 검토)
- Student-Group N:M 관계 변경 (계정 모델 전환 시 별도 진행)
- UI 대폭 변경 (기존 연도 선택 UI 유지)

## 사용자 시나리오

1. **과거 연도 통계 조회**: 교리교사가 대시보드에서 2024년을 선택 → 2024년 당시 학년별 출석률, 우수 학생 목록(당시 이름), 성별 분포가 해당 시점 기준으로 표시됨
2. **졸업 학생 포함 확인**: 2024년에 중3이었던 학생이 2025년 졸업 처리됨 → 2024년 통계에서 해당 학생의 출석이 정상 포함
3. **학년 전환 후 과거 조회**: 2025년 신학기에 중1→중2로 진급 → 2024년 통계에서는 "중1반" 소속으로 표시됨
4. **학생 정보 변경 후 과거 조회**: 학생 이름을 "김철수"→"김영희"로 수정 → 2024년 통계에서는 당시 이름 "김철수"로 표시됨
5. **현재 연도 통계**: 2026년 통계는 기존과 동일하게 동작 (변경 시 자동 스냅샷)

## 요구사항

### 필수 (Must)

- [ ] StudentSnapshot 테이블 생성: `studentId`, `societyName`, `catholicName`, `gender`, `groupId`, `snapshotAt`
- [ ] GroupSnapshot 테이블 생성: `groupId`, `name`, `snapshotAt`
- [ ] Student 변경(수정, 졸업, 학년 전환) 시 StudentSnapshot 자동 생성
- [ ] Group 변경(수정, 삭제) 시 GroupSnapshot 자동 생성
- [ ] Attendance 테이블에 `groupId` 컬럼 추가 (출석 시점의 그룹)
- [ ] 출석 기록(생성/수정) 시 해당 학생의 현재 groupId를 Attendance에 저장
- [ ] 모든 통계 UseCase에서 스냅샷 데이터 사용: 특정 날짜 기준 가장 최근 스냅샷 조회
- [ ] 과거 통계 조회 시 졸업 학생 포함 (`graduatedAt` 필터 제거)
- [ ] 출석률 분모(학생 수)를 해당 기간에 attendance 레코드가 존재하는 학생 수로 계산
- [ ] 기존 데이터 마이그레이션: 현재 Student/Group 상태를 초기 스냅샷으로 생성 + Attendance에 groupId 역보정

### 선택 (Should)

- [ ] 마이그레이션 스크립트의 역보정 정확도 로그 (매칭 성공/실패 건수)

### 제외 (Out)

- 다중 연도 비교 통계
- Student-Group 관계 변경 (N:M)
- 대시보드 UI 리디자인

## 제약/가정/리스크

- **제약**: MySQL (PlanetScale) 사용, Prisma ORM
- **가정**:
  - 기존 데이터에는 변경 이력이 없으므로, 마이그레이션 시 현재 Student/Group 상태를 유일한 스냅샷으로 생성
  - 학년 전환이 연 1회 발생하므로, 현재 상태 스냅샷이 최근 연도에는 유효함
- **리스크**:
  - 과거 데이터 역보정 정확도: 2022~2025년 중간 변경 이력이 없으므로 현재 상태가 모든 과거 연도에 적용됨 → 최선 추정
  - 삭제된 그룹의 attendance 레코드: groupId는 남아있지만 GroupSnapshot이 없을 수 있음 → "삭제된 학년"으로 표시

## 의존성

- **내부**: Student 도메인 (수정/졸업/학년 전환 로직), Group 도메인 (수정/삭제 로직), Attendance 도메인 (생성/수정 로직), Statistics 도메인 (모든 UseCase)
- **외부**: 없음

## 롤아웃/검증

- **출시 단계**: 단일 배포 (DB 마이그레이션 + 코드 변경)
- **이벤트/로그**: 마이그레이션 결과 로그 (스냅샷 생성 건수, Attendance groupId 역보정 건수)
- **검증 방법**: 장위동 2024년 통계 조회 → 졸업 학생 포함 여부, 그룹 배치 정확도 확인

## 오픈 이슈

- [ ] 분모 계산 방식 확정: "해당 기간에 attendance 레코드가 있는 학생 수" vs "스냅샷 시점 그룹 소속 학생 수"

## 연결 문서

- 사업 문서: `docs/business/6_roadmap/roadmap.md` (2단계)
- 기능 설계: `docs/specs/functional-design/statistics.md`
- PRD: `docs/specs/prd/school-attendance.md` (기본 통계)

---

**작성일**: 2026-02-24
**작성자**: SDD 작성자
**상태**: Draft

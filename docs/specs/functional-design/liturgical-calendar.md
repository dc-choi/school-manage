# 기능 설계: 전례 시기/전례력 달력

> PRD를 기반으로 구체적인 기능 흐름과 인터페이스를 정의합니다.

## 연결 문서

- PRD: `docs/specs/prd/liturgical-calendar.md`
- 사업 문서: `docs/business/6_roadmap/roadmap.md` (2단계)

## 기능 범위

| 기능 | 설명 | 상태 |
|------|------|------|
| 전례 시기 계산 API | 현재 날짜 기준 전례 시기 + 다가오는 축일 반환 | 신규 |
| 대시보드 전례 카드 | 전례 시기 + 다가오는 축일 표시 | 신규 |

---

## 전례 시기 계산

### 전례 시기 정의

가톨릭 전례력은 5개 시기로 구성됩니다.

| 시기 | 전례색 | 시작 | 종료 |
|------|--------|------|------|
| 대림 시기 | 보라 | 대림 제1주일 (11/30에 가장 가까운 주일) | 12/24 |
| 성탄 시기 | 흰 | 12/25 | 주님 세례 축일 (주님 공현 대축일 다음 주일, 단 공현이 1/7~8이면 다음 날 월요일) |
| 사순 시기 | 보라 | 재의 수요일 (부활 -46일) | 성목요일 주님 만찬 미사 전 (부활 -3일) |
| 부활 시기 | 흰 | 부활 대축일 | 성령 강림 대축일 (부활 +49일) |
| 연중 시기 | 초록 | 성탄 시기 종료 다음 날 ~ 사순 시기 전날 + 성령 강림 다음 날 ~ 대림 시기 전날 |

### 계산 알고리즘 요약

1. `calculateEaster(year)`로 부활 대축일 결정
2. 부활 기준으로 사순/부활/성령강림 날짜 계산
3. 대림 제1주일: 12/25 기준 직전 4번째 주일 (11/27~12/3 범위)
4. 성탄 시기 종료: 주님 세례 축일 결정
5. 현재 날짜가 속하는 시기 판별 + 연중 시기 주차 계산

### 연중 시기 주차 계산

- 전반부: 주님 세례 축일 다음 날(월)부터 시작, 재의 수요일 전까지
- 후반부: 성령 강림 다음 주 월요일부터 시작, 대림 전까지
- 후반부는 34주(그리스도왕 대축일)부터 역산

---

## 사용자 플로우

1. 사용자가 대시보드 진입
2. 전례 시기 API 자동 호출 (현재 연도 기준)
3. 전례 카드에 현재 전례 시기명, 전례색, 다가오는 축일 3개 표시

---

## UI/UX

### 대시보드 전례 카드

통계 카드 영역 상단에 위치합니다.

```
┌──────────────────────────────────────┐
│ ● 연중 제7주일                        │
│                                      │
│   다가오는 축일                        │
│   ├ 4/5 (일) 부활 대축일              │
│   ├ 5/5 (월) 어린이날                 │
│   └ 5/17 (일) 주님 승천 대축일        │
└──────────────────────────────────────┘
```

| 요소 | 설명 |
|------|------|
| `●` 컬러 도트 | 전례색 표시 (보라/흰/초록/빨강) |
| 시기명 | "대림 제2주일", "연중 제15주일" 등 |
| 다가오는 축일 | 오늘 이후 가장 가까운 축일 3개 (날짜 + 이름) |

### 전례색 매핑

| 전례색 | Tailwind 색상 |
|--------|---------------|
| 보라 (대림/사순) | `bg-purple-500` |
| 흰 (성탄/부활) | `bg-amber-300` (흰색은 배경에서 안 보이므로 금색 대체) |
| 초록 (연중) | `bg-green-500` |
| 빨강 (성령 강림 등) | `bg-red-500` |

---

## API/인터페이스

### tRPC 프로시저

| 프로시저 | 타입 | 인증 | 설명 |
|----------|------|------|------|
| `liturgical.holydays` | query | consented | 축일 목록 (기존) |
| `liturgical.season` | query | consented | 전례 시기 + 다가오는 축일 (신규) |

### liturgical.season (신규)

- **요청**: `year` (number, 선택 — 미입력 시 현재 연도)
- **응답**:

| 필드 | 타입 | 설명 |
|------|------|------|
| `season` | string | 전례 시기명 (예: "연중 제7주일") |
| `color` | string | 전례색 코드 ("purple" / "white" / "green" / "red") |
| `upcomingHolydays` | Holyday[] | 다가오는 축일 3개 (기존 11개 의무축일에서 필터, Holyday 타입 재사용) |

---

## 권한/보안

- `consentedProcedure` 사용 (인증 + 개인정보 동의 필요)
- DB 접근 없음 (순수 계산)

---

## 예외/엣지 케이스

| 상황 | 처리 방법 |
|------|----------|
| 연말 (대림 시기 시작 후) | 다가오는 축일에 다음 해 축일 포함 |
| 12/31 (성탄 시기) | 현재 연도 축일 소진 시 다음 해 축일 계산하여 3개 채움 |
| 주님 세례 축일 경계 | 한국 규칙: 주님 공현(1/2~1/8 주일) 다음 주일, 공현이 1/7~8이면 다음 날(월) |
| 성령 강림 당일 | 부활 시기 (빨강 전례색 — 해당일만 특수) |

---

## 성능/제약

- DB 접근 없이 순수 계산 — 응답 시간 < 10ms
- 클라이언트 캐시: `staleTime: 1일` (전례 시기는 하루 단위 변경)

---

## 측정/모니터링

- **이벤트**: `liturgical_card_viewed` (대시보드 전례 카드 노출 시, GA4)

---

## 테스트 시나리오

### 정상 케이스

1. **TC-1**: 연중 시기 중 조회 → "연중 제N주일" + 초록 반환
2. **TC-2**: 대림 시기 중 조회 → "대림 제N주일" + 보라 반환
3. **TC-3**: 부활 당일 조회 → "부활 대축일" + 흰 반환
4. **TC-4**: 다가오는 축일 3개 정확히 반환 (날짜순)

### 예외 케이스

1. **TC-E1**: 12/31 조회 → 다가오는 축일에 다음 해 축일 포함
2. **TC-E2**: 모든 축일이 지난 후 → 다음 해 축일로 채움

---

**작성일**: 2026-02-18
**작성자**: SDD 작성자
**상태**: Approved
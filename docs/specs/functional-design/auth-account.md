# 기능 설계: 인증 및 계정 관리

> PM 에이전트가 작성하는 기능 설계 문서입니다.
> PRD를 기반으로 구체적인 기능 흐름과 인터페이스를 정의합니다.

## 연결 문서

- PRD: `docs/specs/prd/school-attendance.md` (회원가입 포함)
- PRD: `docs/specs/prd/privacy-consent.md` (개인정보 제공동의)
- PRD: `docs/specs/prd/account-self-management.md` (계정 자기 관리)
- PRD: `docs/specs/prd/self-onboarding.md` (셀프 온보딩)

---

## 기본 인증 (구현 완료)

### 흐름/상태

#### 사용자 플로우

1. 사용자가 로그인 화면에서 ID/비밀번호 입력
2. 시스템이 계정 존재 여부 및 비밀번호 검증
3. 검증 성공 시 Access Token 발급 및 반환
4. 이후 요청에서 토큰을 Authorization 헤더에 포함
5. 시스템이 토큰 유효성 검증 후 요청 처리

#### 상태 전이

```
[비인증] → (로그인 성공) → [인증됨]
[인증됨] → (토큰 만료) → [비인증]
[인증됨] → (로그아웃) → [비인증]
```

### UI/UX

| 화면 | 설명 | 주요 요소 |
|------|------|----------|
| 로그인 | ID/비밀번호 입력 | ID 입력란, 비밀번호 입력란, 로그인 버튼 |
| 헤더 | 로그인 상태 표시 | 계정명 표시, 로그아웃 버튼 |

### API/인터페이스 (기본 인증)

| 프로시저 | 타입 | 인증 | 설명 |
|----------|------|------|------|
| `auth.login` | mutation | public | 로그인 (토큰 발급) |
| `account.get` | query | protected | 현재 계정 정보 조회 |

**auth.login**
- 요청: `name` (string, 필수), `password` (string, 필수)
- 응답: `name`, `displayName`, `accessToken` (JWT)
- 에러: 404 ID NOT_FOUND, 401 PW NOT_MATCHED

**account.get**
- 요청: Authorization Bearer 헤더
- 응답: `name`, `displayName`

### 비즈니스 로직 (기본 인증)

- **로그인**: ID로 계정 조회 → bcrypt 비밀번호 검증 → JWT 발급 (name + timeStamp)
- **토큰 검증**: Bearer 헤더 파싱 → JWT 검증 → timeStamp 만료 확인 → 계정 존재 확인

### 예외/엣지 케이스 (기본 인증)

| 상황 | 처리 방법 |
|------|----------|
| 존재하지 않는 ID | 404 NOT_FOUND |
| 비밀번호 불일치 | 401 UNAUTHORIZED |
| Authorization 헤더 누락/잘못된 형식/만료/위조 | 401 UNAUTHORIZED |

### 테스트 시나리오 (기본 인증)

1. **TC-1**: 유효한 ID/비밀번호로 로그인 → accessToken 반환
2. **TC-2**: 유효한 토큰으로 `account.get` 호출 → 계정 정보 반환
3. **TC-E1**: 존재하지 않는 ID / 잘못된 비밀번호 → 에러 반환
4. **TC-E2**: 토큰 없음/만료 → 401 반환

---

## 회원가입 (로드맵 1단계)

> PRD: `docs/specs/prd/school-attendance.md` (로드맵 1단계 섹션)

### 흐름/상태

```
[로그인 화면] → (회원가입 클릭) → [회원가입 화면]
     ↓
[ID 입력] → (중복 확인) → [이름 입력] → [비밀번호 입력] → [비밀번호 확인]
     ↓
[가입하기 클릭] → (검증 성공) → [계정 생성] → [자동 로그인] → [대시보드]
```

### UI/UX

#### 입력 필드

| 필드 | 타입 | 필수 | 유효성 검증 |
|------|------|------|------------|
| ID (아이디) | text | O | 4~20자, 영문 소문자/숫자만, 중복 불가 |
| displayName (이름) | text | O | 2~20자 |
| password (비밀번호) | password | O | 8자 이상 |
| passwordConfirm (비밀번호 확인) | password | O | password와 일치 |

#### 유효성 피드백

| 상황 | 메시지 |
|------|--------|
| ID 형식/길이 오류 | "영문 소문자와 숫자만 사용 가능합니다" / "4~20자로 입력해주세요" |
| ID 중복/사용 가능 | "이미 사용 중인 아이디입니다" / "사용 가능한 아이디입니다" (성공) |
| 이름 길이 오류 | "2~20자로 입력해주세요" |
| 비밀번호 오류 | "8자 이상 입력해주세요" / "비밀번호가 일치하지 않습니다" |

### 데이터/도메인 변경

**Account 테이블**

| 필드 | 타입 | 설명 |
|------|------|------|
| _id | bigint (PK) | 계정 고유 식별자 |
| name | varchar(20) | 로그인 ID (영문 소문자/숫자) |
| display_name | varchar(20) | 표시용 이름 |
| password | varchar(200) | bcrypt 해싱된 비밀번호 |
| create_at | datetime | 생성일시 |
| update_at | datetime | 수정일시 |
| delete_at | datetime | 삭제일시 (소프트 삭제) |

### API/인터페이스 (회원가입)

| 프로시저 | 타입 | 인증 | 설명 |
|----------|------|------|------|
| `auth.signup` | mutation | public | 회원가입 (계정 생성 + 토큰 발급) |
| `auth.checkId` | query | public | ID 중복 확인 |

**auth.checkId**
- 요청: `name` (string, 4~20자, 영문 소문자/숫자)
- 응답: `available` (boolean)
- 에러: 400 Invalid ID format

**auth.signup**
- 요청: `name`, `displayName`, `password` (유효성 검증은 입력 필드 참조)
- 응답: `name`, `displayName`, `accessToken` (JWT) — 가입 후 자동 로그인
- 에러: 409 ID already exists, 400 유효성 검증 실패

### 비즈니스 로직 (회원가입)

- **ID 중복 확인**: name 소문자 정규화 → 형식 검증 → DB 조회 → available 반환
- **회원가입**: 입력 검증 → ID 중복 확인 → bcrypt 해싱 (saltRounds=10) → 계정 생성 → JWT 발급

### 권한/보안

- `auth.signup`, `auth.checkId`: 인증 불필요 (공개)
- 비밀번호 bcrypt 해싱, ID 소문자 정규화
- Rate limiting 고려 (향후)

### 예외/엣지 케이스 (회원가입)

| 상황 | 처리 방법 |
|------|----------|
| ID 형식/길이 오류 | 400 BAD_REQUEST (대문자는 소문자로 자동 변환) |
| ID 중복 | 409 CONFLICT |
| 이름/비밀번호 길이 오류 | 400 BAD_REQUEST |

### 측정/모니터링

| 이벤트 | 설명 |
|--------|------|
| `signup_started` | 회원가입 화면 진입 |
| `signup_id_check` | ID 중복 확인 (available 파라미터) |
| `signup_submitted` | 가입 버튼 클릭 |
| `signup_completed` | 가입 성공 (accountId 파라미터) |
| `signup_failed` | 가입 실패 (reason 파라미터) |

### 테스트 시나리오 (회원가입)

1. **TC-S1**: 유효한 정보로 회원가입 → 계정 생성, 자동 로그인, 대시보드 이동
2. **TC-S2**: ID 중복 확인 → 사용 가능/중복 결과 반환
3. **TC-S3**: 대문자 ID 입력 → 소문자로 변환
4. **TC-SE1**: ID/이름/비밀번호 유효성 오류 → 400
5. **TC-SE2**: 중복 ID로 가입 → 409

---

## 회원가입 알림 (로드맵 1단계)

> 신규 회원가입 시 운영자에게 메일 알림을 발송합니다.

### 배경

- 신규 회원가입 발생을 운영자가 알 수 없음
- 파일럿 확대 기회 놓침, 마케팅 채널 효과 측정 어려움

### 설계 원칙

1. **비동기 처리**: 메일 발송이 회원가입 응답을 지연시키지 않음
2. **실패 무해**: 메일 발송 실패 시 로그만 기록, 회원가입은 성공
3. **단순 구현**: Nodemailer + Google SMTP (무료, 일 500건)

### 시스템 플로우

```
[사용자] 회원가입 → [SignupUseCase] 계정 생성 → 메일 발송 트리거 (비동기) → [MailService] 운영자 알림
```

사용자 응답은 메일 발송과 독립적으로 즉시 반환.

### 메일 내용

- 제목: `[출석부] 신규 회원가입: {displayName}`
- 본문: 닉네임 표시
- 구현: `apps/api/src/infrastructure/mail/`

### 환경변수

| 변수명 | 용도 |
|-------|-----|
| `SMTP_USER` | Gmail 계정 |
| `SMTP_PASS` | Gmail 앱 비밀번호 (16자리) |
| `ADMIN_EMAIL` | 운영자 수신 주소 |

> 환경변수 미설정 시 메일 발송 비활성화 (앱 정상 동작)

### 예외 케이스

| 상황 | 처리 방법 |
|-----|---------|
| 환경변수 미설정 | 메일 발송 비활성화 |
| SMTP 연결 실패/타임아웃 | 에러 로그 기록, 회원가입 성공 |

---

## 로그인/회원가입 UI 개선 (로드맵 1단계 + 후속)

> 사업 근거: `docs/business/STATUS.md` (이탈율 73.3%, P0)
> 사업 근거: `docs/business/3_gtm/gtm.md` (전환 경로 옵션 B)
> 이 섹션은 "로그인 서비스 소개 + 계정 모델 안내"와 "로그인 페이지 전환율 개선"을 병합한 최종 상태입니다.

### 배경

- **이탈율 73.3%**: 인스타그램 → 로그인 페이지 유입은 양호하나, 회원가입 전환에 실패
- **원인**: 타겟 불명확, 스크린샷 없음, CTA 약함, 사회적 증거 없음, 인스타→로그인 경험 단절

### 목표

- 로그인 페이지 이탈율 73.3% → 50% 이하
- 방문자가 3초 내에 "누구를 위한 / 무엇을 하는 / 어떻게 생긴" 서비스인지 파악

### 범위

| 포함 | 제외 |
|------|------|
| AuthLayout 스플릿 레이아웃 (히어로 + 카드) | 별도 랜딩페이지 → **1단계 격상, `landing-page.md`에서 별도 설계** |
| `account.count` 공개 API (사회적 증거용) | 동적 데모/인터랙션 |
| LoginForm/SignupPage CTA 강화 | 인스타그램 연동 |
| 제품 스크린샷 + 페이지 전환 애니메이션 | |

### 설계 결정

> 기존 결정("카드 내부 스크린샷은 과도")을 **폐기**한다.
> 스플릿 레이아웃의 왼쪽 히어로 영역에 스크린샷을 배치하면
> 카드 크기는 유지하면서 마케팅 콘텐츠를 충분히 전달할 수 있다.

### UI/UX

#### AuthLayout: 스플릿 레이아웃

```
데스크톱 (lg 이상):
┌────────────────────┬────────────────────┐
│  Hero Section      │  Card Section      │
│  - 타겟 메시지      │  - Login/Signup    │
│  - 스크린샷 이미지   │    Card            │
│  - 사회적 증거       │                    │
└────────────────────┴────────────────────┘

모바일 (lg 미만): 히어로 (텍스트만, 스크린샷 숨김) → 카드 (풀 너비)
```

#### 히어로 섹션

| 요소 | 내용 |
|------|------|
| 타겟 메시지 | "가톨릭 교회 모임 운영, 더 쉽게" |
| 서브 메시지 | "출석, 학생, 통계를 한곳에서 관리하세요" |
| 스크린샷 | 대시보드 캡처 (`/images/screenshot-dashboard.png`, 최대 480px) |
| 사회적 증거 | "{N}개 단체가 가입했습니다" (동적, `account.count` API) |

- 히어로 배경: 그라데이션 (primary 계열)
- 이미지 미배치 시 스크린샷 영역 숨김 (graceful degradation)

#### LoginForm 변경

| 요소 | 변경 |
|------|------|
| 기능 안내 (아이콘 3개) + CardDescription | **제거** (히어로 섹션으로 역할 이전) |
| 회원가입 링크 | **버튼으로 승격**: "지금 바로 시작하세요!" (`variant="outline"`) → `/signup` |

#### SignupPage 변경

| 요소 | 변경 |
|------|------|
| CardDescription | "모임 하나당 계정 하나로 관리합니다" |
| 계정 모델 안내 | 폼 상단 안내 박스: "모임당 하나의 계정으로 출석, 학생, 통계를 관리합니다. 운영자가 여러 명이면 같은 계정을 공유하세요." |
| 가입 버튼 | "무료로 시작하기" (primary) |
| 로그인 링크 | **버튼으로 승격**: "이미 계정이 있으신가요?" (`variant="ghost"`) → `/login` |

#### 페이지 전환 애니메이션

- 히어로는 양쪽 페이지에서 동일하므로 **카드 영역만 진입 애니메이션** 적용
- 방식: CSS `@keyframes` fade + slide-up (200ms ease-out), 컴포넌트 마운트 시 자동 트리거
- 퇴장 애니메이션은 라이브러리 없이 구현 불가하므로 미적용

### API/인터페이스

| 프로시저 | 타입 | 인증 | 설명 |
|----------|------|------|------|
| `account.count` | query | **public** | 전체 가입 계정 수 조회 |

- 요청: 없음 (파라미터 없는 query)
- 응답: `count` (number) — 소프트 삭제 계정 제외

### 예외/엣지 케이스

| 상황 | 처리 방법 |
|------|----------|
| 모바일 (lg 미만) | 히어로 텍스트만 표시, 스크린샷 숨김 |
| 스크린샷 로드 실패 | alt 텍스트 표시, 레이아웃 유지 |
| account.count API 실패 | 사회적 증거 영역 숨김 |
| 계정 수 0 | 사회적 증거 영역 숨김 |

### 측정/모니터링

| 지표 | 목표 |
|------|------|
| 기존 `signup_started` 이벤트 | 전환율 증가 확인 |
| GA4 이탈율 | 73.3% → 50% 이하 |

### 테스트 시나리오

1. **TC-CV1**: 데스크톱에서 스플릿 레이아웃 (히어로 + 카드) 정상 표시
2. **TC-CV2**: 히어로에 타겟 메시지 + 스크린샷 + 사회적 증거 동적 표시
3. **TC-CV3**: 모바일에서 히어로 텍스트만, 스크린샷 숨김
4. **TC-CV4**: LoginForm/SignupPage CTA 버튼 동작 및 페이지 이동
5. **TC-CV5**: 페이지 전환 시 카드 fade-in 애니메이션
6. **TC-CVE1**: 스크린샷 로드 실패 / API 실패 / 계정 수 0 → graceful degradation

---

## 개인정보 제공동의 (로드맵 2단계)

> PRD: `docs/specs/prd/privacy-consent.md`
> 사업 근거: `docs/business/4_risk/risks.md` (리스크 6: 학생/보호자 정보 민감성)
> 사업 근거: `docs/business/6_roadmap/roadmap.md` (2단계 P0)

### 배경

- 현재 회원가입 시 개인정보 수집·이용에 대한 동의 절차 없음
- 개인정보보호법상 수집 목적·항목·보유 기간 고지 및 동의 필수
- 기존 가입 회원(5개 단체)에 대한 소급 동의 수집 필요

### 사용자 플로우

**신규 가입**:

```
/signup → ID·이름·비밀번호 입력
   ↓
"개인정보 수집·이용 동의" 체크박스 선택 (필수)
   ↓ ("개인정보 처리방침 보기" → 모달로 처리방침 표시)
체크 완료 → "무료로 시작하기" 활성화 → 가입
   ↓
계정 생성 (privacyAgreedAt 자동 기록) → 자동 로그인 → /
```

**기존 회원 소급 동의**:

```
/login → 로그인 성공 → 토큰 발급
   ↓
account.get → privacyAgreedAt: null 확인
   ↓
/consent 강제 리다이렉트 (다른 페이지 접근 불가)
   ↓
개인정보 처리방침 표시 + 동의 체크박스
   ↓
"동의하고 계속하기" → account.agreePrivacy → privacyAgreedAt 기록
   ↓
원래 목적지(/) 로 이동
```

**동의 거부 시**:

```
/consent → "동의하지 않습니다" 클릭
   ↓
확인 다이얼로그: "동의하지 않으면 서비스를 이용할 수 없습니다. 로그아웃하시겠습니까?"
   ↓
확인 → 로그아웃 → /login
```

### 상태 전이

```
[미동의 상태]
  ├→ (신규 가입 시 동의) → [동의 완료]
  ├→ (소급 동의) → [동의 완료]
  └→ (거부) → [로그아웃]

[동의 완료] → 모든 보호된 기능 접근 가능
```

### 라우팅

| 경로 | 컴포넌트 | 인증 | 비고 |
|------|----------|------|------|
| `/consent` | ConsentPage | protected (인증만, 동의 불필요) | 소급 동의 화면 |

> 개인정보 처리방침은 독립 페이지 없이 `PrivacyPolicyContent` 공유 컴포넌트로 관리 (SignupPage: 모달, ConsentPage: 인라인 스크롤)

### UI/UX

**회원가입 페이지 변경 (`/signup`)**

기존 폼 하단(비밀번호 확인 아래, 가입 버튼 위)에 동의 체크박스 추가:

```
┌─────────────────────────────────┐
│  (기존 필드: ID, 이름, 비밀번호) │
│                                 │
│  ☐ 개인정보 수집·이용에 동의합니다 (필수)  │
│     [개인정보 처리방침 보기]       │
│                                 │
│  [ 무료로 시작하기 ]             │
└─────────────────────────────────┘
```

- 체크박스 미선택 시 가입 버튼 비활성화 (기존 isFormValid에 조건 추가)
- "개인정보 처리방침 보기" 클릭 → 모달로 처리방침 표시

**소급 동의 페이지 (`/consent`)**

```
┌─────────────────────────────────┐
│  개인정보 수집·이용 동의         │
│                                 │
│  ┌───────────────────────────┐ │
│  │  (개인정보 처리방침 본문)  │ │
│  │  스크롤 가능 영역          │ │
│  └───────────────────────────┘ │
│                                 │
│  ☐ 위의 개인정보 수집·이용에     │
│    동의합니다                    │
│                                 │
│  [ 동의하고 계속하기 ]           │
│                                 │
│  동의하지 않습니다 (로그아웃)    │
└─────────────────────────────────┘
```

- 체크박스 미선택 시 "동의하고 계속하기" 비활성화
- "동의하지 않습니다" → AlertDialog 확인 후 로그아웃
- 네비게이션/사이드바 없음 (AuthLayout 사용, 단독 화면)

### 개인정보 처리방침 내용

| # | 항목 | 내용 |
|---|------|------|
| 1 | 수집 항목 | 가. 계정 정보: 아이디, 이름(닉네임), 비밀번호(암호화) / 나. 학생 정보: 이름, 세례명, 성별, 나이, 연락처, 세례일, 메모, 출석 기록 |
| 2 | 수집 목적 | 가. 계정 정보: 서비스 회원 식별 및 인증 / 나. 학생 정보: 출석부 관리 서비스 제공 |
| 3 | 민감정보 처리 | 세례명·세례일은 종교 관련 민감정보, 선택 입력, 출석 관리 목적으로만 사용 |
| 4 | 보유 기간 | 회원 탈퇴 시까지 (탈퇴 시 계정 및 관련 학생 정보 즉시 비활성화 처리, 비활성화 후 2년 이내 파기) |
| 5 | 위탁/제3자 제공 | 없음 |
| 6 | 이용자 권리 | 동의 철회, 열람·정정·삭제 요청 가능 |
| 7 | 사용자(교사) 책임 | 학생 정보는 사용자 책임 하에 수집·관리, 학생/보호자 동의는 교사 본인 책임 |

### 데이터/도메인 변경

**Account 테이블 필드 추가**

| 필드 | 타입 | 설명 |
|------|------|------|
| privacyAgreedAt | DateTime? | 개인정보 동의 일시 (null = 미동의) |

- DB 컬럼명: `privacy_agreed_at`
- 기존 회원: 마이그레이션 시 null (미동의 상태)
- 신규 가입: 가입 시점으로 자동 설정

### API/인터페이스

| 프로시저 | 타입 | 인증 | 동의 필요 | 설명 |
|----------|------|------|-----------|------|
| `auth.signup` | mutation | public | - | 회원가입 (변경: privacyAgreed 필드 추가) |
| `account.get` | query | protected | **불필요** | 계정 정보 (변경: privacyAgreedAt 반환 추가) |
| `account.agreePrivacy` | mutation | protected | **불필요** | 개인정보 동의 기록 (신규) |

**auth.signup 변경**

- 요청 추가 필드: `privacyAgreed` (boolean, 필수, true만 허용)
- 동작: `privacyAgreed === true`일 때 `privacyAgreedAt`에 현재 시각 기록
- 에러: `privacyAgreed`가 false/누락 → 400 BAD_REQUEST

**account.get 변경**

- 응답 추가 필드: `privacyAgreedAt` (DateTime | null)
- 프론트엔드에서 null 여부로 소급 동의 필요 판단

**account.agreePrivacy (신규)**

- 요청: 없음 (인증 토큰으로 계정 식별)
- 동작: 현재 계정의 `privacyAgreedAt`에 현재 시각 기록
- 응답: `privacyAgreedAt` (DateTime)
- 에러: 이미 동의한 경우 → 현재 값 반환 (멱등)

### 접근 제어 (동의 기반)

| 구분 | 인증 | 동의 | 접근 가능 API |
|------|------|------|-------------|
| 비인증 | X | - | auth.login, auth.signup, auth.checkId, account.count |
| 인증 + 미동의 | O | X | account.get, account.agreePrivacy |
| 인증 + 동의 | O | O | 모든 보호된 API (group, student, attendance, statistics 등) |

- 미동의 상태에서 동의 불필요 API 외 접근 시 → 에러 응답 (403 또는 별도 코드)
- 프론트엔드: ProtectedRoute에서 `privacyAgreedAt` null → `/consent` 리다이렉트

### 예외/엣지 케이스

| 상황 | 처리 방법 |
|------|----------|
| 신규 가입 시 privacyAgreed: false | 400 BAD_REQUEST (가입 차단) |
| 기존 회원 로그인 → privacyAgreedAt null | /consent로 강제 리다이렉트 |
| /consent에서 동의 거부 | 확인 다이얼로그 → 로그아웃 |
| 이미 동의한 사용자가 /consent 접근 | / 리다이렉트 |
| 미동의 상태에서 보호된 API 직접 호출 | 403 FORBIDDEN 반환 |
| account.agreePrivacy 중복 호출 | 멱등 처리 (기존 값 반환) |

### 측정/모니터링

| 이벤트 | 설명 |
|--------|------|
| `privacy_consent_shown` | 동의 화면 노출 (signup 내 / consent 페이지) |
| `privacy_consent_agreed` | 동의 완료 (source: signup / consent) |
| `privacy_consent_declined` | 동의 거부 (consent 페이지에서 로그아웃) |

### 테스트 시나리오

1. **TC-PC1**: 신규 가입 — 동의 체크 후 가입 → privacyAgreedAt 기록, 대시보드 정상 접근
2. **TC-PC2**: 신규 가입 — 동의 미체크 → 가입 버튼 비활성화
3. **TC-PC3**: 기존 회원 로그인 → privacyAgreedAt null → /consent 리다이렉트
4. **TC-PC4**: /consent에서 동의 → privacyAgreedAt 기록 → 대시보드 이동
5. **TC-PC5**: /consent에서 거부 → 확인 다이얼로그 → 로그아웃
6. **TC-PC6**: 미동의 상태에서 보호된 API 호출 → 403
7. **TC-PC7**: 동의 완료 사용자가 /consent 접근 → / 리다이렉트
8. **TC-PC8**: 회원가입 폼에서 "개인정보 처리방침 보기" 클릭 → 모달로 처리방침 표시

---

## 계정 자기 관리 (로드맵 2단계)

> PRD: `docs/specs/prd/account-self-management.md`
> 사업 근거: `docs/business/6_roadmap/roadmap.md` (2단계 P0)

### 배경

- 비밀번호 분실 시 운영자 개입 필요, 이름 변경/계정 탈퇴 불가
- 개인정보 처리방침 "동의 철회, 삭제 요청 가능" 이행을 위한 탈퇴 기능 필수

### 사용자 플로우

**비밀번호 재설정** (비인증 상태):

```
/login → "비밀번호 찾기" 클릭 → /reset-password
   ↓
아이디 + 이메일 입력 → "임시 비밀번호 발송" 클릭
   ↓
auth.resetPassword API 호출
   ↓ (계정 존재 확인 → 임시 비밀번호 생성 → bcrypt 해싱 → DB 업데이트 → 이메일 발송)
성공 메시지 표시 → /login으로 이동
   ↓
임시 비밀번호로 로그인 → /settings에서 비밀번호 변경
```

**비밀번호 변경** (인증 상태):

```
/settings → 비밀번호 변경 섹션
   ↓
현재 비밀번호 + 새 비밀번호 + 새 비밀번호 확인 입력
   ↓
account.changePassword API 호출
   ↓ (현재 비밀번호 검증 → 새 비밀번호 bcrypt 해싱 → DB 업데이트)
성공 메시지 → 세션 클리어 → /login 리다이렉트 (새 비밀번호로 재로그인)
```

**이름 변경** (인증 상태):

```
/settings → 이름 변경 섹션
   ↓
새 이름 입력 → "저장" 클릭
   ↓
account.updateProfile API 호출 → 성공 메시지
```

**계정 탈퇴** (인증 상태):

```
/settings → 위험 영역 섹션 → "계정 삭제" 클릭
   ↓
AlertDialog: "모든 데이터가 삭제됩니다. 삭제 후 2년 이내에 동일한 아이디와 비밀번호로 로그인하면 계정을 복원할 수 있습니다."
   ↓
비밀번호 입력 → "삭제" 클릭
   ↓
account.deleteAccount API 호출
   ↓ (비밀번호 검증 → 출석 → 학생 → 그룹 → 계정 순서로 소프트 삭제)
세션 클리어 → /login 리다이렉트
```

**계정 복원** (비인증 상태):

```
/login → 삭제된 계정으로 로그인 시도 → auth.login에서 ACCOUNT_DELETED 에러 반환
   ↓
프론트엔드에서 복원 확인 다이얼로그 표시
   ↓
auth.restoreAccount API 호출
   ↓ (비밀번호 검증 → 2년 이내 확인 → 트랜잭션 내 cascade 복원 → JWT 발급)
자동 로그인 → 대시보드 이동
```

### 상태 전이

```
[인증됨] → (비밀번호 변경) → [세션 만료] → [비인증]
[인증됨] → (이름 변경) → [인증됨] (프로필 갱신)
[인증됨] → (계정 탈퇴) → [계정 삭제됨] → [비인증]
[비인증] → (비밀번호 재설정) → [비인증] (이메일 발송 완료)
[계정 삭제됨] → (로그인 시도) → (복원 확인) → [인증됨] (cascade 복원)
[계정 삭제됨] → (2년 경과) → [복원 불가]
```

### 라우팅

| 경로 | 컴포넌트 | 인증 | 비고 |
|------|----------|------|------|
| `/settings` | SettingsPage | consented | 계정 설정 (MainLayout) |
| `/reset-password` | ResetPasswordPage | **불필요** (public) | 비밀번호 재설정 (AuthLayout) |

### UI/UX

**계정 설정 페이지 (`/settings`)**

MainLayout 사용 (사이드바 + 헤더). 3개 섹션으로 구성.

```
┌─────────────────────────────────────────┐
│  계정 설정                               │
│                                         │
│  ── 이름 변경 ──────────────────────────  │
│  이름        [현재 이름        ] [저장]   │
│                                         │
│  ── 비밀번호 변경 ──────────────────────  │
│  현재 비밀번호  [                ]        │
│  새 비밀번호    [                ]        │
│  비밀번호 확인  [                ]        │
│                            [변경하기]    │
│                                         │
│  ── 위험 영역 ──────────────────────────  │
│  계정을 삭제하면 모든 데이터가 영구 삭제됩니다.│
│                         [계정 삭제]      │
└─────────────────────────────────────────┘
```

- 이름 변경: 인라인 수정 (Input + 저장 버튼)
- 비밀번호 변경: 3개 필드 (현재/새/확인) + 변경 버튼
- 위험 영역: 붉은 테두리, destructive 버튼

**비밀번호 재설정 페이지 (`/reset-password`)**

AuthLayout 사용 (로그인과 동일한 레이아웃).

```
┌─────────────────────────────────────────┐
│  비밀번호 찾기                            │
│                                         │
│  아이디    [                ]             │
│  이메일    [                ]             │
│                                         │
│  [ 임시 비밀번호 발송 ]                   │
│                                         │
│  로그인으로 돌아가기                       │
└─────────────────────────────────────────┘
```

- 발송 성공: "임시 비밀번호가 이메일로 발송되었습니다" 메시지
- 발송 실패: 에러 메시지 표시
- 계정 미존재 시에도 동일한 성공 메시지 표시 (계정 존재 여부 노출 방지)

**헤더 프로필 링크**

- 헤더의 사용자 프로필 영역(아이콘 + displayName)을 클릭하면 `/settings`로 이동
- 별도 사이드바 메뉴 없이 헤더 프로필 링크로 접근

### API/인터페이스

| 프로시저 | 타입 | 인증 | 동의 필요 | 설명 |
|----------|------|------|-----------|------|
| `auth.resetPassword` | mutation | **public** | - | 비밀번호 재설정 (임시 비밀번호 발송) |
| `auth.restoreAccount` | mutation | **public** | - | 삭제된 계정 복원 (2년 이내) |
| `account.changePassword` | mutation | consented | O | 비밀번호 변경 |
| `account.updateProfile` | mutation | consented | O | 이름 변경 |
| `account.deleteAccount` | mutation | consented | O | 계정 탈퇴 (소프트 삭제) |

**auth.resetPassword (신규)**

- 요청: `name` (string, 필수), `email` (string, 이메일 형식, 필수)
- 동작: 계정 조회 → 임시 비밀번호 생성 (영문+숫자 12자) → 이메일 발송 (동기) → 성공 시 bcrypt 해싱 → DB 업데이트
- 응답: `{ success: true }` (계정 미존재 시에도 동일 응답 — 존재 여부 노출 방지), 메일 발송 실패 시 `{ success: false, emailFailed: true }`
- 에러: 계정 미존재 → 성공 응답 (보안), SMTP 실패 → `emailFailed: true` 반환 (재시도 유도)

**auth.restoreAccount (신규)**

- 요청: `name` (string, 필수), `password` (string, 필수)
- 동작: 삭제된 계정 조회 → 비밀번호 검증 → 2년 이내 확인 → 트랜잭션 내 cascade 복원 (계정 → 그룹 → 학생 → 출석) → JWT 발급
- 응답: `name`, `displayName`, `accessToken` (JWT) — 복원 후 자동 로그인
- 에러: 404 계정 미존재, 401 비밀번호 불일치, 403 복원 기간 경과

**account.changePassword (신규)**

- 요청: `currentPassword` (string, 필수), `newPassword` (string, 8자 이상, 필수)
- 동작: 현재 비밀번호 검증 → 새 비밀번호 bcrypt 해싱 → DB 업데이트
- 응답: `{ success: true }`
- 에러: 401 현재 비밀번호 불일치

**account.updateProfile (신규)**

- 요청: `displayName` (string, 2~20자, 필수)
- 동작: displayName 업데이트
- 응답: `{ displayName: string }`
- 에러: 400 유효성 오류

**account.deleteAccount (신규)**

- 요청: `password` (string, 필수)
- 동작: 비밀번호 검증 → 트랜잭션 내에서 출석 → 학생 → 그룹 → 계정 순서로 소프트 삭제
- 응답: `{ success: true }`
- 에러: 401 비밀번호 불일치

### 비즈니스 로직

**비밀번호 재설정**:
1. name으로 계정 조회 (deletedAt: null)
2. 계정 미존재 시 → 성공 응답 반환 (계정 존재 여부 노출 방지)
3. 임시 비밀번호 생성: `crypto.randomBytes(6).toString('hex')` → 12자 영숫자
4. 이메일 발송 (**동기**, 실패 시 기존 비밀번호 유지 → `{ success: false, emailFailed: true }` 반환)
5. 발송 성공 시에만 bcrypt 해싱 (saltRounds=10) → DB 업데이트 (password, updatedAt)

**계정 삭제 (cascade 소프트 삭제)**:
```
트랜잭션 {
  1. 비밀번호 검증
  2. 해당 계정의 그룹 ID 목록 조회
  3. 해당 그룹들의 학생 ID 목록 조회
  4. UPDATE attendance SET deletedAt WHERE studentId IN (학생 ID 목록)
  5. UPDATE student SET deletedAt WHERE groupId IN (그룹 ID 목록)
  6. UPDATE group SET deletedAt WHERE accountId = 계정 ID
  7. UPDATE account SET deletedAt WHERE id = 계정 ID
}
```

### 권한/보안

- `auth.resetPassword`: 공개 (rate limiting 권장)
- `account.changePassword`, `account.updateProfile`, `account.deleteAccount`: consentedProcedure (인증 + 동의 필수)
- 비밀번호 재설정 시 계정 존재 여부 미노출 (타이밍 공격 미고려, 소규모 서비스)
- 계정 삭제 시 비밀번호 재확인 필수

### 예외/엣지 케이스

| 상황 | 처리 방법 |
|------|----------|
| 존재하지 않는 ID로 재설정 요청 | 성공 응답 반환 (보안) |
| SMTP 미설정/발송 실패 | `{ success: false, emailFailed: true }` 반환 (재시도 유도) |
| 현재 비밀번호 불일치 (변경/탈퇴) | 401 UNAUTHORIZED |
| 새 비밀번호 유효성 오류 | 400 BAD_REQUEST |
| displayName 유효성 오류 | 400 BAD_REQUEST |
| 계정 삭제 중 DB 오류 | 트랜잭션 롤백, 500 에러 |
| 이미 삭제된 계정으로 요청 | 401 (토큰 검증 실패) |
| 삭제된 계정으로 로그인 시도 | ACCOUNT_DELETED 에러 → 프론트에서 복원 다이얼로그 표시 |
| 복원 기간(2년) 경과 | 403 FORBIDDEN |
| 복원 시 비밀번호 불일치 | 401 UNAUTHORIZED |

### 측정/모니터링

| 이벤트 | 설명 |
|--------|------|
| `password_reset_requested` | 비밀번호 재설정 요청 (성공 여부 무관) |
| `password_changed` | 비밀번호 변경 완료 |
| `display_name_changed` | 이름 변경 완료 |
| `account_deleted` | 계정 탈퇴 완료 |

### 테스트 시나리오

1. **TC-SM1**: 존재하는 계정으로 비밀번호 재설정 요청 → 성공 응답, 임시 비밀번호로 로그인 가능
2. **TC-SM2**: 존재하지 않는 계정으로 재설정 → 동일한 성공 응답 (보안)
3. **TC-SM3**: 현재 비밀번호로 비밀번호 변경 → 새 비밀번호로 로그인 가능
4. **TC-SM4**: 잘못된 현재 비밀번호로 변경 시도 → 401
5. **TC-SM5**: displayName 변경 → 변경된 이름 반환
6. **TC-SM6**: 비밀번호 확인 후 계정 삭제 → 계정/그룹/학생/출석 전체 소프트 삭제
7. **TC-SM7**: 잘못된 비밀번호로 탈퇴 시도 → 401
8. **TC-SME1**: SMTP 미설정/발송 실패 시 재설정 요청 → `{ success: false, emailFailed: true }` 반환

---

## 셀프 온보딩 — 최소 가이드 (로드맵 2단계)

> PRD: `docs/specs/prd/self-onboarding.md`
> 사업 근거: `docs/business/STATUS.md` (고덕동/돈암동/신당동/신정동 이탈 분석)

### 배경

- 자가 가입 4곳 모두 가입 후 진행 멈춤 (완료율 ~25%)
- 원인: "다음에 뭘 해야 하는지 모름" + "그룹/학생 구조 미이해"
- 현재 대시보드는 빈 차트/테이블만 표시, 안내 문구 없음

### 사용자 플로우

```
/signup → 가입 완료 → 자동 로그인 → / (대시보드)
   ↓
대시보드: 온보딩 체크리스트 표시 (일반 대시보드 대신)
   ↓
① "학년 만들기" 클릭 → /groups/new → 학년 생성 → 대시보드 복귀
   ↓ (1단계 완료 ✅)
② "학생 등록" 클릭 → /students/new → 학생 등록 → 대시보드 복귀
   ↓ (2단계 완료 ✅)
③ "출석 체크" 클릭 → /attendance → 출석 기록 → 대시보드 복귀
   ↓ (3단계 완료 ✅)
온보딩 완료 → 일반 대시보드 표시
```

### 상태 전이

```
[온보딩 미완료] → (학년 생성) → [1단계 완료]
[1단계 완료]   → (학생 등록) → [2단계 완료]
[2단계 완료]   → (출석 기록) → [온보딩 완료]
[온보딩 완료]  → 일반 대시보드
```

### 온보딩 완료 판단 기준

기존 API 데이터로 판단 (신규 API 없음):

| 단계 | 완료 조건 | 사용 API |
|------|----------|----------|
| ① 학년 만들기 | 학년 1개 이상 존재 | `group.list` |
| ② 학생 등록 | 학생 1명 이상 존재 | `student.list` |
| ③ 출석 체크 | 출석 기록 1건 이상 존재 | 기존 통계 API |

- 모든 단계 완료 = 온보딩 완료 → 체크리스트 미표시, 일반 대시보드 표시
- 데이터 전체 삭제 시 체크리스트 재표시 (의도적 수용 — 데이터 없으면 안내 유용)

### UI/UX

#### 대시보드 온보딩 체크리스트

온보딩 미완료 시 일반 대시보드 대신 체크리스트 표시:

```
┌─────────────────────────────────────────┐
│  시작하기 가이드                          │
│  "3단계만 완료하면 바로 사용할 수 있어요"   │
│                                         │
│  ┌─────────────────────────────────┐    │
│  │ ✅ 1. 학년 만들기               │    │
│  │    반이나 모임을 만들어보세요     │    │
│  └─────────────────────────────────┘    │
│  ┌─────────────────────────────────┐    │
│  │ → 2. 학생 등록하기    [등록하기] │    │
│  │    학생을 추가하면 출석 체크를    │    │
│  │    시작할 수 있어요              │    │
│  └─────────────────────────────────┘    │
│  ┌─────────────────────────────────┐    │
│  │ ○ 3. 출석 체크하기              │    │
│  │    날짜를 선택하고 출석을         │    │
│  │    체크해보세요                  │    │
│  └─────────────────────────────────┘    │
└─────────────────────────────────────────┘
```

#### 단계별 상태 표시

| 상태 | 표시 | CTA 버튼 | 스타일 |
|------|------|----------|--------|
| 완료 | ✅ 체크 아이콘 + 취소선 | 없음 | 비활성 (muted) |
| 현재 (다음 미완료) | → 화살표 강조 | 활성 버튼 | 강조 (primary border) |
| 대기 | ○ 빈 원 | 없음 | 비활성 (muted) |

#### 온보딩 완료 시

모든 단계 완료 후 대시보드 진입 시 체크리스트 미표시, 일반 대시보드(통계/차트) 즉시 표시.

#### 빈 상태 안내 강화 (Should)

| 페이지 | 현재 빈 상태 메시지 | 개선 |
|--------|-------------------|------|
| 학년 목록 (`/groups`) | "등록된 학년이 없습니다." | + "학년을 만들면 학생을 등록할 수 있어요" |
| 학생 목록 (`/students`) | "등록된 학생이 없습니다." | + "학생을 등록하면 출석 체크를 시작할 수 있어요" |

### 데이터/도메인 변경

없음 (프론트엔드만 변경)

### API/인터페이스

신규 API 없음. 기존 API 재활용:

| 프로시저 | 용도 |
|----------|------|
| `group.list` | 학년 존재 여부 판단 |
| `student.list` | 학생 존재 여부 판단 |
| 기존 통계 API | 출석 기록 존재 여부 판단 |

### 예외/엣지 케이스

| 상황 | 처리 방법 |
|------|----------|
| 학년 있지만 학생 0명 | 2단계 진행 중 (체크리스트 표시) |
| 학생 있지만 출석 0건 | 3단계 진행 중 (체크리스트 표시) |
| 모든 데이터 삭제 후 재진입 | 체크리스트 재표시 (수용 가능) |
| API 로딩 중 | 체크리스트 로딩 상태 표시 |
| API 에러 | 일반 대시보드 표시 (fallback) |

### 측정/모니터링

| 이벤트 | 설명 | 파라미터 |
|--------|------|----------|
| `onboarding_checklist_shown` | 체크리스트 표시 시 | step (현재 단계) |
| `onboarding_step_clicked` | 단계 CTA 클릭 시 | step (클릭한 단계) |
| `onboarding_completed` | 모든 단계 완료 시 | days_since_signup (가입 후 경과일) |

### 테스트 시나리오

1. **TC-OB1**: 학년/학생/출석 0건 사용자 → 대시보드에 체크리스트 표시, 1단계 강조
2. **TC-OB2**: 학년 1개 이상, 학생 0명 → 1단계 완료, 2단계 강조
3. **TC-OB3**: 학년+학생 있음, 출석 0건 → 1·2단계 완료, 3단계 강조
4. **TC-OB4**: 출석 기록 1건 이상 → 체크리스트 미표시, 일반 대시보드 표시
5. **TC-OB5**: 체크리스트 CTA 클릭 → 해당 페이지로 이동
6. **TC-OBE1**: API 에러 → 일반 대시보드 표시 (fallback)

---

## 공통 사항

### 권한별 접근

| 권한 | 접근 가능 기능 |
|------|---------------|
| 비인증 | 랜딩 페이지, 로그인, 회원가입, ID 중복 확인, 계정 수 조회, **비밀번호 재설정**, **계정 복원** |
| 인증 + 미동의 | 계정 정보 조회, 개인정보 동의 |
| 인증 + 동의 완료 | 모든 보호된 기능, **계정 설정 (비밀번호 변경, 이름 변경, 탈퇴)** |

### 성능/제약

- 예상 트래픽: 동시 접속 수십 명 이내
- 제약 사항:
  - Access Token만 사용 (Refresh Token 미지원)
  - 토큰 만료 시 재로그인 필요

---

**작성일**: 2026-01-13
**최종 수정**: 2026-02-18
**작성자**: PM 에이전트
**상태**: Approved (구현 완료)

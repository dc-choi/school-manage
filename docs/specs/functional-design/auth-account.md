# 기능 설계: 인증 및 계정 관리

> PM 에이전트가 작성하는 기능 설계 문서입니다.
> PRD를 기반으로 구체적인 기능 흐름과 인터페이스를 정의합니다.

## 연결 문서

- PRD: `docs/specs/prd/school-attendance.md` (회원가입 포함)
- PRD: `docs/specs/prd/privacy-consent.md` (개인정보 제공동의)

---

## 기본 인증 (구현 완료)

### 흐름/상태

#### 사용자 플로우

1. 사용자가 로그인 화면에서 ID/비밀번호 입력
2. 시스템이 계정 존재 여부 및 비밀번호 검증
3. 검증 성공 시 Access Token 발급 및 반환
4. 이후 요청에서 토큰을 Authorization 헤더에 포함
5. 시스템이 토큰 유효성 검증 후 요청 처리

#### 상태 전이

```
[비인증] → (로그인 성공) → [인증됨]
[인증됨] → (토큰 만료) → [비인증]
[인증됨] → (로그아웃) → [비인증]
```

### UI/UX

| 화면 | 설명 | 주요 요소 |
|------|------|----------|
| 로그인 | ID/비밀번호 입력 | ID 입력란, 비밀번호 입력란, 로그인 버튼 |
| 헤더 | 로그인 상태 표시 | 계정명 표시, 로그아웃 버튼 |

### API/인터페이스 (기본 인증)

| 프로시저 | 타입 | 인증 | 설명 |
|----------|------|------|------|
| `auth.login` | mutation | public | 로그인 (토큰 발급) |
| `account.get` | query | protected | 현재 계정 정보 조회 |

**auth.login**
- 요청: `name` (string, 필수), `password` (string, 필수)
- 응답: `name`, `displayName`, `accessToken` (JWT)
- 에러: 404 ID NOT_FOUND, 401 PW NOT_MATCHED

**account.get**
- 요청: Authorization Bearer 헤더
- 응답: `name`, `displayName`

### 비즈니스 로직 (기본 인증)

- **로그인**: ID로 계정 조회 → bcrypt 비밀번호 검증 → JWT 발급 (name + timeStamp)
- **토큰 검증**: Bearer 헤더 파싱 → JWT 검증 → timeStamp 만료 확인 → 계정 존재 확인

### 예외/엣지 케이스 (기본 인증)

| 상황 | 처리 방법 |
|------|----------|
| 존재하지 않는 ID | 404 NOT_FOUND |
| 비밀번호 불일치 | 401 UNAUTHORIZED |
| Authorization 헤더 누락/잘못된 형식/만료/위조 | 401 UNAUTHORIZED |

### 테스트 시나리오 (기본 인증)

1. **TC-1**: 유효한 ID/비밀번호로 로그인 → accessToken 반환
2. **TC-2**: 유효한 토큰으로 `account.get` 호출 → 계정 정보 반환
3. **TC-E1**: 존재하지 않는 ID / 잘못된 비밀번호 → 에러 반환
4. **TC-E2**: 토큰 없음/만료 → 401 반환

---

## 회원가입 (로드맵 1단계)

> PRD: `docs/specs/prd/school-attendance.md` (로드맵 1단계 섹션)

### 흐름/상태

```
[로그인 화면] → (회원가입 클릭) → [회원가입 화면]
     ↓
[ID 입력] → (중복 확인) → [이름 입력] → [비밀번호 입력] → [비밀번호 확인]
     ↓
[가입하기 클릭] → (검증 성공) → [계정 생성] → [자동 로그인] → [대시보드]
```

### UI/UX

#### 입력 필드

| 필드 | 타입 | 필수 | 유효성 검증 |
|------|------|------|------------|
| ID (아이디) | text | O | 4~20자, 영문 소문자/숫자만, 중복 불가 |
| displayName (이름) | text | O | 2~20자 |
| password (비밀번호) | password | O | 8자 이상 |
| passwordConfirm (비밀번호 확인) | password | O | password와 일치 |

#### 유효성 피드백

| 상황 | 메시지 |
|------|--------|
| ID 형식/길이 오류 | "영문 소문자와 숫자만 사용 가능합니다" / "4~20자로 입력해주세요" |
| ID 중복/사용 가능 | "이미 사용 중인 아이디입니다" / "사용 가능한 아이디입니다" (성공) |
| 이름 길이 오류 | "2~20자로 입력해주세요" |
| 비밀번호 오류 | "8자 이상 입력해주세요" / "비밀번호가 일치하지 않습니다" |

### 데이터/도메인 변경

**Account 테이블**

| 필드 | 타입 | 설명 |
|------|------|------|
| _id | bigint (PK) | 계정 고유 식별자 |
| name | varchar(20) | 로그인 ID (영문 소문자/숫자) |
| display_name | varchar(20) | 표시용 이름 |
| password | varchar(200) | bcrypt 해싱된 비밀번호 |
| create_at | datetime | 생성일시 |
| update_at | datetime | 수정일시 |
| delete_at | datetime | 삭제일시 (소프트 삭제) |

### API/인터페이스 (회원가입)

| 프로시저 | 타입 | 인증 | 설명 |
|----------|------|------|------|
| `auth.signup` | mutation | public | 회원가입 (계정 생성 + 토큰 발급) |
| `auth.checkId` | query | public | ID 중복 확인 |

**auth.checkId**
- 요청: `name` (string, 4~20자, 영문 소문자/숫자)
- 응답: `available` (boolean)
- 에러: 400 Invalid ID format

**auth.signup**
- 요청: `name`, `displayName`, `password` (유효성 검증은 입력 필드 참조)
- 응답: `name`, `displayName`, `accessToken` (JWT) — 가입 후 자동 로그인
- 에러: 409 ID already exists, 400 유효성 검증 실패

### 비즈니스 로직 (회원가입)

- **ID 중복 확인**: name 소문자 정규화 → 형식 검증 → DB 조회 → available 반환
- **회원가입**: 입력 검증 → ID 중복 확인 → bcrypt 해싱 (saltRounds=10) → 계정 생성 → JWT 발급

### 권한/보안

- `auth.signup`, `auth.checkId`: 인증 불필요 (공개)
- 비밀번호 bcrypt 해싱, ID 소문자 정규화
- Rate limiting 고려 (향후)

### 예외/엣지 케이스 (회원가입)

| 상황 | 처리 방법 |
|------|----------|
| ID 형식/길이 오류 | 400 BAD_REQUEST (대문자는 소문자로 자동 변환) |
| ID 중복 | 409 CONFLICT |
| 이름/비밀번호 길이 오류 | 400 BAD_REQUEST |

### 측정/모니터링

| 이벤트 | 설명 |
|--------|------|
| `signup_started` | 회원가입 화면 진입 |
| `signup_id_check` | ID 중복 확인 (available 파라미터) |
| `signup_submitted` | 가입 버튼 클릭 |
| `signup_completed` | 가입 성공 (accountId 파라미터) |
| `signup_failed` | 가입 실패 (reason 파라미터) |

### 테스트 시나리오 (회원가입)

1. **TC-S1**: 유효한 정보로 회원가입 → 계정 생성, 자동 로그인, 대시보드 이동
2. **TC-S2**: ID 중복 확인 → 사용 가능/중복 결과 반환
3. **TC-S3**: 대문자 ID 입력 → 소문자로 변환
4. **TC-SE1**: ID/이름/비밀번호 유효성 오류 → 400
5. **TC-SE2**: 중복 ID로 가입 → 409

---

## 회원가입 알림 (로드맵 1단계)

> 신규 회원가입 시 운영자에게 메일 알림을 발송합니다.

### 배경

- 신규 회원가입 발생을 운영자가 알 수 없음
- 파일럿 확대 기회 놓침, 마케팅 채널 효과 측정 어려움

### 설계 원칙

1. **비동기 처리**: 메일 발송이 회원가입 응답을 지연시키지 않음
2. **실패 무해**: 메일 발송 실패 시 로그만 기록, 회원가입은 성공
3. **단순 구현**: Nodemailer + Google SMTP (무료, 일 500건)

### 시스템 플로우

```
[사용자] 회원가입 → [SignupUseCase] 계정 생성 → 메일 발송 트리거 (비동기) → [MailService] 운영자 알림
```

사용자 응답은 메일 발송과 독립적으로 즉시 반환.

### 메일 내용

- 제목: `[출석부] 신규 회원가입: {displayName}`
- 본문: 닉네임 표시
- 구현: `apps/api/src/infrastructure/mail/`

### 환경변수

| 변수명 | 용도 |
|-------|-----|
| `SMTP_USER` | Gmail 계정 |
| `SMTP_PASS` | Gmail 앱 비밀번호 (16자리) |
| `ADMIN_EMAIL` | 운영자 수신 주소 |

> 환경변수 미설정 시 메일 발송 비활성화 (앱 정상 동작)

### 예외 케이스

| 상황 | 처리 방법 |
|-----|---------|
| 환경변수 미설정 | 메일 발송 비활성화 |
| SMTP 연결 실패/타임아웃 | 에러 로그 기록, 회원가입 성공 |

---

## 로그인/회원가입 UI 개선 (로드맵 1단계 + 후속)

> 사업 근거: `docs/business/STATUS.md` (이탈율 73.3%, P0)
> 사업 근거: `docs/business/3_gtm/gtm.md` (전환 경로 옵션 B)
> 이 섹션은 "로그인 서비스 소개 + 계정 모델 안내"와 "로그인 페이지 전환율 개선"을 병합한 최종 상태입니다.

### 배경

- **이탈율 73.3%**: 인스타그램 → 로그인 페이지 유입은 양호하나, 회원가입 전환에 실패
- **원인**: 타겟 불명확, 스크린샷 없음, CTA 약함, 사회적 증거 없음, 인스타→로그인 경험 단절

### 목표

- 로그인 페이지 이탈율 73.3% → 50% 이하
- 방문자가 3초 내에 "누구를 위한 / 무엇을 하는 / 어떻게 생긴" 서비스인지 파악

### 범위

| 포함 | 제외 |
|------|------|
| AuthLayout 스플릿 레이아웃 (히어로 + 카드) | 별도 랜딩페이지 → **1단계 격상, `landing-page.md`에서 별도 설계** |
| `account.count` 공개 API (사회적 증거용) | 동적 데모/인터랙션 |
| LoginForm/SignupPage CTA 강화 | 인스타그램 연동 |
| 제품 스크린샷 + 페이지 전환 애니메이션 | |

### 설계 결정

> 기존 결정("카드 내부 스크린샷은 과도")을 **폐기**한다.
> 스플릿 레이아웃의 왼쪽 히어로 영역에 스크린샷을 배치하면
> 카드 크기는 유지하면서 마케팅 콘텐츠를 충분히 전달할 수 있다.

### UI/UX

#### AuthLayout: 스플릿 레이아웃

```
데스크톱 (lg 이상):
┌────────────────────┬────────────────────┐
│  Hero Section      │  Card Section      │
│  - 타겟 메시지      │  - Login/Signup    │
│  - 스크린샷 이미지   │    Card            │
│  - 사회적 증거       │                    │
└────────────────────┴────────────────────┘

모바일 (lg 미만): 히어로 (텍스트만, 스크린샷 숨김) → 카드 (풀 너비)
```

#### 히어로 섹션

| 요소 | 내용 |
|------|------|
| 타겟 메시지 | "가톨릭 교회 모임 운영, 더 쉽게" |
| 서브 메시지 | "출석, 멤버, 통계를 한곳에서 관리하세요" |
| 스크린샷 | 대시보드 캡처 (`/images/screenshot-dashboard.png`, 최대 480px) |
| 사회적 증거 | "{N}개 단체가 가입했습니다" (동적, `account.count` API) |

- 히어로 배경: 그라데이션 (primary 계열)
- 이미지 미배치 시 스크린샷 영역 숨김 (graceful degradation)

#### LoginForm 변경

| 요소 | 변경 |
|------|------|
| 기능 안내 (아이콘 3개) + CardDescription | **제거** (히어로 섹션으로 역할 이전) |
| 회원가입 링크 | **버튼으로 승격**: "지금 바로 시작하세요!" (`variant="outline"`) → `/signup` |

#### SignupPage 변경

| 요소 | 변경 |
|------|------|
| CardDescription | "모임 하나당 계정 하나로 관리합니다" |
| 계정 모델 안내 | 폼 상단 안내 박스: "모임당 하나의 계정으로 출석, 멤버, 통계를 관리합니다. 운영자가 여러 명이면 같은 계정을 공유하세요." |
| 가입 버튼 | "무료로 시작하기" (primary) |
| 로그인 링크 | **버튼으로 승격**: "이미 계정이 있으신가요?" (`variant="ghost"`) → `/login` |

#### 페이지 전환 애니메이션

- 히어로는 양쪽 페이지에서 동일하므로 **카드 영역만 진입 애니메이션** 적용
- 방식: CSS `@keyframes` fade + slide-up (200ms ease-out), 컴포넌트 마운트 시 자동 트리거
- 퇴장 애니메이션은 라이브러리 없이 구현 불가하므로 미적용

### API/인터페이스

| 프로시저 | 타입 | 인증 | 설명 |
|----------|------|------|------|
| `account.count` | query | **public** | 전체 가입 계정 수 조회 |

- 요청: 없음 (파라미터 없는 query)
- 응답: `count` (number) — 소프트 삭제 계정 제외

### 예외/엣지 케이스

| 상황 | 처리 방법 |
|------|----------|
| 모바일 (lg 미만) | 히어로 텍스트만 표시, 스크린샷 숨김 |
| 스크린샷 로드 실패 | alt 텍스트 표시, 레이아웃 유지 |
| account.count API 실패 | 사회적 증거 영역 숨김 |
| 계정 수 0 | 사회적 증거 영역 숨김 |

### 측정/모니터링

| 지표 | 목표 |
|------|------|
| 기존 `signup_started` 이벤트 | 전환율 증가 확인 |
| GA4 이탈율 | 73.3% → 50% 이하 |

### 테스트 시나리오

1. **TC-CV1**: 데스크톱에서 스플릿 레이아웃 (히어로 + 카드) 정상 표시
2. **TC-CV2**: 히어로에 타겟 메시지 + 스크린샷 + 사회적 증거 동적 표시
3. **TC-CV3**: 모바일에서 히어로 텍스트만, 스크린샷 숨김
4. **TC-CV4**: LoginForm/SignupPage CTA 버튼 동작 및 페이지 이동
5. **TC-CV5**: 페이지 전환 시 카드 fade-in 애니메이션
6. **TC-CVE1**: 스크린샷 로드 실패 / API 실패 / 계정 수 0 → graceful degradation

---

## 개인정보 제공동의 (로드맵 2단계)

> PRD: `docs/specs/prd/privacy-consent.md`
> 사업 근거: `docs/business/4_risk/risks.md` (리스크 6: 학생/보호자 정보 민감성)
> 사업 근거: `docs/business/6_roadmap/roadmap.md` (2단계 P0)

### 배경

- 현재 회원가입 시 개인정보 수집·이용에 대한 동의 절차 없음
- 개인정보보호법상 수집 목적·항목·보유 기간 고지 및 동의 필수
- 기존 가입 회원(5개 단체)에 대한 소급 동의 수집 필요

### 사용자 플로우

**신규 가입**:

```
/signup → ID·이름·비밀번호 입력
   ↓
"개인정보 수집·이용 동의" 체크박스 선택 (필수)
   ↓ ("개인정보 처리방침 보기" → 모달로 처리방침 표시)
체크 완료 → "무료로 시작하기" 활성화 → 가입
   ↓
계정 생성 (privacyAgreedAt 자동 기록) → 자동 로그인 → /
```

**기존 회원 소급 동의**:

```
/login → 로그인 성공 → 토큰 발급
   ↓
account.get → privacyAgreedAt: null 확인
   ↓
/consent 강제 리다이렉트 (다른 페이지 접근 불가)
   ↓
개인정보 처리방침 표시 + 동의 체크박스
   ↓
"동의하고 계속하기" → account.agreePrivacy → privacyAgreedAt 기록
   ↓
원래 목적지(/) 로 이동
```

**동의 거부 시**:

```
/consent → "동의하지 않습니다" 클릭
   ↓
확인 다이얼로그: "동의하지 않으면 서비스를 이용할 수 없습니다. 로그아웃하시겠습니까?"
   ↓
확인 → 로그아웃 → /login
```

### 상태 전이

```
[미동의 상태]
  ├→ (신규 가입 시 동의) → [동의 완료]
  ├→ (소급 동의) → [동의 완료]
  └→ (거부) → [로그아웃]

[동의 완료] → 모든 보호된 기능 접근 가능
```

### 라우팅

| 경로 | 컴포넌트 | 인증 | 비고 |
|------|----------|------|------|
| `/consent` | ConsentPage | protected (인증만, 동의 불필요) | 소급 동의 화면 |

> 개인정보 처리방침은 독립 페이지 없이 `PrivacyPolicyContent` 공유 컴포넌트로 관리 (SignupPage: 모달, ConsentPage: 인라인 스크롤)

### UI/UX

**회원가입 페이지 변경 (`/signup`)**

기존 폼 하단(비밀번호 확인 아래, 가입 버튼 위)에 동의 체크박스 추가:

```
┌─────────────────────────────────┐
│  (기존 필드: ID, 이름, 비밀번호) │
│                                 │
│  ☐ 개인정보 수집·이용에 동의합니다 (필수)  │
│     [개인정보 처리방침 보기]       │
│                                 │
│  [ 무료로 시작하기 ]             │
└─────────────────────────────────┘
```

- 체크박스 미선택 시 가입 버튼 비활성화 (기존 isFormValid에 조건 추가)
- "개인정보 처리방침 보기" 클릭 → 모달로 처리방침 표시

**소급 동의 페이지 (`/consent`)**

```
┌─────────────────────────────────┐
│  개인정보 수집·이용 동의         │
│                                 │
│  ┌───────────────────────────┐ │
│  │  (개인정보 처리방침 본문)  │ │
│  │  스크롤 가능 영역          │ │
│  └───────────────────────────┘ │
│                                 │
│  ☐ 위의 개인정보 수집·이용에     │
│    동의합니다                    │
│                                 │
│  [ 동의하고 계속하기 ]           │
│                                 │
│  동의하지 않습니다 (로그아웃)    │
└─────────────────────────────────┘
```

- 체크박스 미선택 시 "동의하고 계속하기" 비활성화
- "동의하지 않습니다" → AlertDialog 확인 후 로그아웃
- 네비게이션/사이드바 없음 (AuthLayout 사용, 단독 화면)

### 개인정보 처리방침 내용

| # | 항목 | 내용 |
|---|------|------|
| 1 | 수집 항목 | 가. 계정 정보: 아이디, 이름(닉네임), 비밀번호(암호화) / 나. 학생 정보: 이름, 세례명, 성별, 나이, 연락처, 세례일, 메모, 출석 기록 |
| 2 | 수집 목적 | 가. 계정 정보: 서비스 회원 식별 및 인증 / 나. 학생 정보: 출석부 관리 서비스 제공 |
| 3 | 민감정보 처리 | 세례명·세례일은 종교 관련 민감정보, 선택 입력, 출석 관리 목적으로만 사용 |
| 4 | 보유 기간 | 회원 탈퇴 시까지 (탈퇴 후 계정 및 관련 학생 정보 지체 없이 파기) |
| 5 | 위탁/제3자 제공 | 없음 |
| 6 | 이용자 권리 | 동의 철회, 열람·정정·삭제 요청 가능 |
| 7 | 사용자(교사) 책임 | 학생 정보는 사용자 책임 하에 수집·관리, 학생/보호자 동의는 교사 본인 책임 |

### 데이터/도메인 변경

**Account 테이블 필드 추가**

| 필드 | 타입 | 설명 |
|------|------|------|
| privacyAgreedAt | DateTime? | 개인정보 동의 일시 (null = 미동의) |

- DB 컬럼명: `privacy_agreed_at`
- 기존 회원: 마이그레이션 시 null (미동의 상태)
- 신규 가입: 가입 시점으로 자동 설정

### API/인터페이스

| 프로시저 | 타입 | 인증 | 동의 필요 | 설명 |
|----------|------|------|-----------|------|
| `auth.signup` | mutation | public | - | 회원가입 (변경: privacyAgreed 필드 추가) |
| `account.get` | query | protected | **불필요** | 계정 정보 (변경: privacyAgreedAt 반환 추가) |
| `account.agreePrivacy` | mutation | protected | **불필요** | 개인정보 동의 기록 (신규) |

**auth.signup 변경**

- 요청 추가 필드: `privacyAgreed` (boolean, 필수, true만 허용)
- 동작: `privacyAgreed === true`일 때 `privacyAgreedAt`에 현재 시각 기록
- 에러: `privacyAgreed`가 false/누락 → 400 BAD_REQUEST

**account.get 변경**

- 응답 추가 필드: `privacyAgreedAt` (DateTime | null)
- 프론트엔드에서 null 여부로 소급 동의 필요 판단

**account.agreePrivacy (신규)**

- 요청: 없음 (인증 토큰으로 계정 식별)
- 동작: 현재 계정의 `privacyAgreedAt`에 현재 시각 기록
- 응답: `privacyAgreedAt` (DateTime)
- 에러: 이미 동의한 경우 → 현재 값 반환 (멱등)

### 접근 제어 (동의 기반)

| 구분 | 인증 | 동의 | 접근 가능 API |
|------|------|------|-------------|
| 비인증 | X | - | auth.login, auth.signup, auth.checkId, account.count |
| 인증 + 미동의 | O | X | account.get, account.agreePrivacy |
| 인증 + 동의 | O | O | 모든 보호된 API (group, student, attendance, statistics 등) |

- 미동의 상태에서 동의 불필요 API 외 접근 시 → 에러 응답 (403 또는 별도 코드)
- 프론트엔드: ProtectedRoute에서 `privacyAgreedAt` null → `/consent` 리다이렉트

### 예외/엣지 케이스

| 상황 | 처리 방법 |
|------|----------|
| 신규 가입 시 privacyAgreed: false | 400 BAD_REQUEST (가입 차단) |
| 기존 회원 로그인 → privacyAgreedAt null | /consent로 강제 리다이렉트 |
| /consent에서 동의 거부 | 확인 다이얼로그 → 로그아웃 |
| 이미 동의한 사용자가 /consent 접근 | / 리다이렉트 |
| 미동의 상태에서 보호된 API 직접 호출 | 403 FORBIDDEN 반환 |
| account.agreePrivacy 중복 호출 | 멱등 처리 (기존 값 반환) |

### 측정/모니터링

| 이벤트 | 설명 |
|--------|------|
| `privacy_consent_shown` | 동의 화면 노출 (signup 내 / consent 페이지) |
| `privacy_consent_agreed` | 동의 완료 (source: signup / consent) |
| `privacy_consent_declined` | 동의 거부 (consent 페이지에서 로그아웃) |

### 테스트 시나리오

1. **TC-PC1**: 신규 가입 — 동의 체크 후 가입 → privacyAgreedAt 기록, 대시보드 정상 접근
2. **TC-PC2**: 신규 가입 — 동의 미체크 → 가입 버튼 비활성화
3. **TC-PC3**: 기존 회원 로그인 → privacyAgreedAt null → /consent 리다이렉트
4. **TC-PC4**: /consent에서 동의 → privacyAgreedAt 기록 → 대시보드 이동
5. **TC-PC5**: /consent에서 거부 → 확인 다이얼로그 → 로그아웃
6. **TC-PC6**: 미동의 상태에서 보호된 API 호출 → 403
7. **TC-PC7**: 동의 완료 사용자가 /consent 접근 → / 리다이렉트
8. **TC-PC8**: 회원가입 폼에서 "개인정보 처리방침 보기" 클릭 → 모달로 처리방침 표시

---

## 공통 사항

### 권한별 접근

| 권한 | 접근 가능 기능 |
|------|---------------|
| 비인증 | 랜딩 페이지, 로그인, 회원가입, ID 중복 확인, 계정 수 조회 |
| 인증 + 미동의 | 계정 정보 조회, 개인정보 동의 |
| 인증 + 동의 완료 | 모든 보호된 기능 |

### 성능/제약

- 예상 트래픽: 동시 접속 수십 명 이내
- 제약 사항:
  - Access Token만 사용 (Refresh Token 미지원)
  - 토큰 만료 시 재로그인 필요
  - 비밀번호 찾기 미지원 (1단계)

---

**작성일**: 2026-01-13
**최종 수정**: 2026-02-15
**작성자**: PM 에이전트
**상태**: Approved (구현 완료)

# 기능 설계: 그룹 관리

> PRD를 기반으로 구체적인 기능 흐름과 인터페이스를 정의합니다.

## 연결 문서

- PRD: `docs/specs/prd/school-attendance.md`

## 흐름/상태

### 사용자 플로우

**기본 플로우:**
1. 사용자가 로그인 후 그룹 목록 화면 진입
2. 계정에 속한 그룹 목록 조회
3. 그룹 추가 또는 특정 그룹 선택
4. 그룹 선택 시 해당 그룹의 상세 페이지로 이동

**상세 페이지 플로우 (로드맵 1단계):**
1. 그룹 상세 페이지에서 그룹 정보 확인
2. 그룹명 인라인 수정 가능
3. 소속 학생 목록 조회
4. 출석 현황 화면으로 이동
5. 그룹 목록으로 복귀 → **이전 페이지 번호 유지** (페이지네이션 도입 시)

**일괄 삭제 플로우 (로드맵 1단계):**
1. 그룹 목록에서 다중 선택 체크박스 활성화
2. 삭제할 그룹 선택
3. 일괄 삭제 버튼 클릭
4. 확인 후 소프트 삭제 처리

### 상태 전이

```
[그룹 목록] → (그룹 클릭) → [그룹 상세]
[그룹 상세] → (인라인 수정) → [그룹 수정 완료] → [그룹 상세]
[그룹 상세] → (출석 현황) → [출석 현황 화면]
[그룹 목록] → (그룹 추가) → [그룹 생성 완료] → [그룹 목록]
[그룹 목록] → (다중 선택 + 일괄 삭제) → [그룹 소프트 삭제] → [그룹 목록]
```

## UI/UX

### 화면/컴포넌트

| 화면 | 설명 | 주요 요소 |
|------|------|----------|
| 그룹 목록 | 계정의 모든 그룹 표시 | 그룹 테이블, 추가 버튼, 다중 선택 체크박스, 일괄 삭제 버튼 |
| 그룹 상세 | 그룹 정보 및 소속 학생 | 그룹명 (인라인 수정), 학생 목록 테이블, 출석 현황 링크 |
| 그룹 추가 | 신규 그룹 생성 | 그룹명 입력란, 저장 버튼 |

### 그룹 목록 화면 (로드맵 1단계)

| 요소 | 설명 |
|------|------|
| 테이블 헤더 | 선택 체크박스, 그룹명, 학생 수, 생성일 |
| 테이블 행 | 클릭 시 상세 페이지 이동 (전체 행이 클릭 영역) |
| 다중 선택 | 헤더의 전체 선택 체크박스, 각 행의 개별 체크박스 |
| 일괄 삭제 버튼 | 선택된 그룹이 있을 때만 활성화 |

### 그룹 상세 화면 (로드맵 1단계)

| 요소 | 설명 |
|------|------|
| 그룹명 | 인라인 수정 가능 (클릭 또는 편집 아이콘으로 수정 모드 진입) |
| 학생 목록 | 소속 학생 테이블 (이름, 세례명, 나이 등) |
| 출석 현황 버튼 | 출석 현황 페이지로 이동 |
| 뒤로 가기 | 그룹 목록으로 복귀 |

### 권한별 차이

| 권한 | 접근 가능 기능 |
|------|---------------|
| 인증된 사용자 | 본인 계정의 그룹 전체 CRUD |

## 페이지네이션 상태 유지 (로드맵 1단계)

> 현재 그룹 목록은 전체 로드 방식(페이지네이션 없음)입니다.
> 계정당 그룹 수가 10개 이내로 불필요하지만, 향후 도입 시 학생 관리와 동일한 URL 쿼리 파라미터 패턴(`/groups?page=N`)을 적용합니다.

## 데이터/도메인 변경

### Group 테이블

| 필드 | 타입 | 설명 |
|------|------|------|
| _id | bigint (PK) | 그룹 고유 식별자 |
| name | varchar(50) | 그룹명 (예: 중1-1반) |
| account_id | bigint (FK) | 소속 계정 ID |
| create_at | datetime | 생성일시 |
| update_at | datetime | 수정일시 |
| delete_at | datetime | 삭제일시 (소프트 삭제) |

마이그레이션: 없음 (기존 스키마 유지)

## API/인터페이스

### tRPC 프로시저

| 프로시저 | 타입 | 설명 |
|----------|------|------|
| `group.list` | query | 그룹 목록 조회 |
| `group.get` | query | 그룹 상세 조회 (학생 목록 포함) |
| `group.create` | mutation | 그룹 생성 |
| `group.update` | mutation | 그룹 수정 (인라인 수정용) |
| `group.delete` | mutation | 그룹 삭제 (소프트) |
| `group.bulkDelete` | mutation | 그룹 일괄 삭제 (로드맵 1단계) |
| `group.attendance` | query | 그룹 출석 현황 조회 |

### 주요 필드

| 프로시저 | 요청 필드 | 응답 필드 |
|----------|----------|----------|
| `group.list` | - | account(string), groups(array: _id, name, accountId) |
| `group.get` | groupId(number) | group(_id, name, accountId, studentCount), students(array: _id, societyName, catholicName, age) |
| `group.create` | name(string, 필수) | group(_id, name, accountId) |
| `group.update` | groupId(number), name(string) | group 정보 |
| `group.bulkDelete` | groupIds(number[], 필수) | deletedCount(number) |
| `group.attendance` | groupId(number), year(number) | year, sunday/saturday(날짜 배열), students(array), attendances(array) |

## 비즈니스 로직

| 기능 | 동작 요약 |
|------|----------|
| 그룹 목록 | accountId 기준 deletedAt=null인 그룹 조회 |
| 그룹 상세 | groupId로 조회 + 소속 학생 목록 포함, 미존재 시 404 |
| 그룹 생성 | name + account_id로 생성 |
| 그룹 수정 | groupId로 name 업데이트 |
| 그룹 삭제 | deletedAt = now (소프트 삭제) |
| 그룹 일괄 삭제 | groupIds 배열 → 존재하는 그룹만 소프트 삭제, deletedCount 반환 |
| 출석 현황 | groupId + year → 주일/토요일 날짜 + 학생 + 출석 데이터 반환 |

## 권한/보안

- 모든 그룹 API: Bearer 토큰 필수
- 계정 소유권 검증 미구현 → TARGET 등록됨 (`auth-ownership-validation`)

## 예외/엣지 케이스

| 상황 | 처리 방법 |
|------|----------|
| 잘못된 groupId | 400 BAD_REQUEST |
| 존재하지 않는 그룹 | 404 NOT_FOUND |
| 그룹명 누락 | 400 BAD_REQUEST |
| year 누락/비정상 | 현재 연도로 대체 |
| 토큰 누락 | 401 UNAUTHORIZED |
| 일괄 삭제 빈 배열 | 400 BAD_REQUEST |
| 일괄 삭제 일부 그룹 없음 | 존재하는 그룹만 삭제 |
| 인라인 수정 빈 그룹명 | 400 BAD_REQUEST |

## 성능/제약

- 계정당 그룹 수 10개 이내
- 삭제는 소프트 삭제 (deletedAt 설정)

## 테스트 시나리오

### 정상 케이스

1. 그룹 목록 조회 → groups 배열 반환
2. 그룹 생성/수정/삭제 → 처리된 그룹 정보 반환
3. 그룹 출석 현황 조회 → year, students, attendances 반환
4. 그룹 상세 조회 → 그룹 정보 + 학생 목록 반환 (로드맵 1단계)
5. 그룹 일괄 삭제 → deletedCount 반환 (로드맵 1단계)

### 예외 케이스

1. 잘못된 groupId → 400
2. 존재하지 않는 그룹 → 404
3. 토큰 없이 호출 → 401
4. 일괄 삭제 빈 배열 → 400 (로드맵 1단계)

---

**작성일**: 2026-01-13
**수정일**: 2026-02-12 (문서 축약 - 동작 명세 수준으로 정리)
**작성자**: PM 에이전트
**상태**: Approved

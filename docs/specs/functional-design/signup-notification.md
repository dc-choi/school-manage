# 기능 설계: 회원가입 알림

> 비기능적 요구사항 (Non-Functional - 측정 인프라)
> 신규 회원가입 시 운영자에게 메일 알림을 발송합니다.

## 연결 문서

- 사업 문서: `docs/business/STATUS.md` (오픈 이슈)
- 참고: `docs/business/5_metrics/metrics.md` (채널/획득 지표)

## 배경/목표

### 문제
- 신규 회원가입이 발생해도 운영자가 알 수 없음
- 어떤 본당에서 유입되었는지 파악 불가
- 파일럿 확대 기회를 놓칠 수 있음
- 마케팅 채널 효과 측정 어려움

### 목표
- 회원가입 발생 시 운영자가 즉시 인지
- 유입 채널 파악 및 파일럿 확대 기회 포착

### 성공 기준
- 회원가입 완료 후 1분 이내 메일 발송
- 메일 발송 실패 시 회원가입은 정상 완료 (비동기/무해)

## 흐름/상태

### 시스템 플로우

```
[사용자] 회원가입 요청
    ↓
[SignupUseCase] 계정 생성
    ↓
[SignupUseCase] 메일 발송 트리거 (비동기)
    ↓
[MailService] 운영자에게 알림 메일 발송
    ↓
[사용자] 회원가입 응답 수신 (메일 발송과 독립)
```

### 설계 원칙

1. **비동기 처리**: 메일 발송이 회원가입 응답을 지연시키지 않음
2. **실패 무해**: 메일 발송 실패 시 로그만 기록, 회원가입은 성공
3. **단순 구현**: Nodemailer + Google SMTP (무료, 일 500건)

## 데이터/도메인 변경

### 스키마 변경
- 없음 (기존 Account 엔티티 활용)

### 메일 내용

| 항목 | 값 |
|-----|---|
| 제목 | `[출석부] 신규 회원가입: {displayName}` |
| 닉네임 | `displayName` |
| 가입 일시 | `createdAt` (KST) |

### 메일 본문 예시

```
신규 회원이 가입했습니다.

- 닉네임: 홍길동
- 가입 일시: 2026-01-28 14:30:25 (KST)

---
출석부 프로그램
```

> **Note**: 계정 ID(name)는 운영 목적상 불필요하므로 제외. 닉네임만 표시.

> **향후 확장**: 본당명은 그룹 생성 시점에 파악 가능. 필요 시 "첫 그룹 생성 알림" 기능 추가 검토.

## API/인터페이스

### 변경 없음
- 기존 `trpc.auth.signup` 엔드포인트 유지
- 응답 형식 변경 없음

### 내부 인터페이스

```typescript
// 메일 발송 서비스
interface MailService {
    sendSignupNotification(account: {
        displayName: string;
        createdAt: Date;
    }): Promise<void>;
}
```

## 인프라 변경

### 신규 파일

```
apps/api/src/infrastructure/mail/
├── index.ts           # export
├── mail.service.ts    # 메일 발송 서비스
└── templates.ts       # 메일 템플릿
```

### 환경변수

| 변수명 | 용도 | 필수 | 예시 |
|-------|-----|-----|-----|
| `SMTP_USER` | Gmail 계정 | Yes | `your-email@gmail.com` |
| `SMTP_PASS` | Gmail 앱 비밀번호 | Yes | (16자리 앱 비밀번호) |
| `ADMIN_EMAIL` | 운영자 수신 주소 | Yes | `admin@example.com` |

> **Google SMTP 설정**:
> - Host: `smtp.gmail.com` (하드코딩)
> - Port: `587` (하드코딩)
> - 발신자: `SMTP_USER` 값 사용
> - 인증: Gmail 앱 비밀번호 필요 (2단계 인증 활성화 후 생성)

### 의존성 추가

```bash
pnpm add nodemailer --filter @school/api
pnpm add -D @types/nodemailer --filter @school/api
```

## 권한/보안

- **접근 제어**: 없음 (내부 시스템 기능)
- **민감 정보**: SMTP 인증 정보는 환경변수로 관리
- **로그**: 메일 발송 성공/실패 로그 기록 (비밀번호 제외)

## 예외/엣지 케이스

| 상황 | 처리 방법 |
|-----|---------|
| 환경변수 미설정 | 메일 발송 비활성화 (앱 정상 동작) |
| SMTP 연결 실패 | 에러 로그 기록, 회원가입 성공 |
| 메일 발송 타임아웃 | 에러 로그 기록, 회원가입 성공 |
| 잘못된 수신자 주소 | 에러 로그 기록, 회원가입 성공 |

## 성능/제약

- **예상 트래픽**: 일 1-5건 (초기 단계)
- **메일 발송 타임아웃**: 10초
- **비동기 처리**: `Promise` fire-and-forget (await 없이 호출)

## 측정/모니터링

- **로그**: 메일 발송 성공/실패 기록
- **GA4 연동**: 없음 (서버 내부 이벤트)

## 테스트 시나리오

### 정상 케이스

1. **TC-1**: 환경변수 설정 시 회원가입 후 메일 발송
   - Given: SMTP 환경변수 정상 설정
   - When: 회원가입 완료
   - Then: 운영자에게 알림 메일 발송

### 예외 케이스

1. **TC-E1**: 환경변수 미설정 시 메일 발송 스킵
   - Given: SMTP 환경변수 미설정
   - When: 회원가입 완료
   - Then: 메일 발송 스킵, 회원가입 성공

2. **TC-E2**: SMTP 연결 실패 시 회원가입 성공
   - Given: SMTP 서버 연결 불가
   - When: 회원가입 완료
   - Then: 에러 로그 기록, 회원가입 성공

---

**작성일**: 2026-01-28
**작성자**: SDD 작성자
**상태**: Approved
**검수일**: 2026-01-28
**검수자**: SDD 검수자

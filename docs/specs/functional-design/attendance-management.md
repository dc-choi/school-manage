# 기능 설계: 출석 관리

> PRD를 기반으로 구체적인 기능 흐름과 인터페이스를 정의합니다.

## 연결 문서

- PRD: `docs/specs/prd/school-attendance.md`

## 기능 범위

| 기능 | 설명 | 상태 |
|------|------|------|
| 기본 출석 관리 | 테이블 뷰, 일괄 저장 | 구현 완료 |
| 자동 저장 (1단계) | 셀 변경 즉시 저장 | 구현 완료 |
| 달력 UI (1단계) | 달력 형태, 모달 입력, 의무축일 표시 | 구현 완료 |

---

## 흐름/상태

```
[출석 조회] → (출석 입력) → [자동 저장] → [출석 조회]
[출석 조회] → (저장 버튼) → [전체 동기화] → [출석 조회]
[출석 조회] → (출석 삭제) → [삭제 완료] → [출석 조회]
```

## UI/UX

| 화면 | 주요 요소 |
|------|----------|
| 출석 현황 (테이블) | 연도 선택, 학생(세로) × 날짜(가로), 출석 입력 셀 |
| 출석 달력 | 학년/월 선택, 날짜별 출석 현황(N/M명), 의무축일 표시 |
| 출석 입력 모달 | 미사/교리 체크박스, 자동 상태 계산, 즉시 저장 |

### 출석 체크 방식

미사+교리=◎, 미사만=○, 교리만=△, 둘 다 없음=결석

---

## 데이터: Attendance 테이블

| 필드 | 타입 | 설명 |
|------|------|------|
| _id | bigint (PK) | 고유 식별자 |
| date | varchar(50) | 출석일 (YYYYMMDD) |
| content | varchar(50) | 출석 내용 (◎/○/△ 등) |
| student_id | bigint (FK) | 학생 ID |
| group_id | bigint (FK) | 출석 시점 그룹 ID |
| create_at / update_at / delete_at | datetime | 생성/수정/삭제일시 |

- **삭제 정책**: Attendance는 **물리 삭제** (개별 레코드 복구 필요성 낮음)

## API

| 프로시저 | 타입 | 설명 |
|----------|------|------|
| `group.attendance` | query | 학년 출석 현황 (테이블 뷰용) |
| `attendance.update` | mutation | 출석 입력/삭제 (자동 저장 + 일괄 겸용) |
| `attendance.calendar` | query | 월별 달력 데이터 (출석 현황 + 의무축일) |
| `attendance.dayDetail` | query | 날짜별 출석 상세 (모달용) |

### 저장 방식

- **자동 저장** (`isFull=false`): 셀 변경 시 개별 1건 즉시 전송, 빈 값이면 물리 삭제
- **명시적 저장** (`isFull=true`): 전체 데이터 동기화
- 저장 상태: 저장 중(스피너) → 완료(체크 2초) → 오류(재시도 버튼)

## 비즈니스 로직

| 기능 | 동작 요약 |
|------|----------|
| 출석 조회 | groupId + year → 주일/토요일 날짜 + 학생 + 출석 데이터 |
| 출석 입력 (isFull=true) | date(YYYYMMDD)로 기존 확인 → 없으면 생성, 있으면 업데이트 |
| 출석 상태 계산 | 미사+교리=◎, 미사만=○, 교리만=△ |
| 달력 데이터 | year+month+groupId → 일별 present/total + 의무축일 |
| 부활 대축일 계산 | Anonymous Gregorian Algorithm |

### 의무축일

- **고정**: 천주의 성모 마리아(1/1), 성모 승천(8/15), 모든 성인(11/1), 한국 성직자·수도자·신자들의 축일(9월 둘째 주일), 성탄(12/25)
- **이동** (부활 기준): 부활, 예수 승천(+40일), 성령 강림(+50일), 삼위일체, 성체 성혈, 예수 성심, 그리스도 왕

## 예외/엣지 케이스

| 상황 | 처리 |
|------|------|
| 잘못된 groupId / attendance 배열 누락 / isFull 누락 | 400 BAD_REQUEST |
| 토큰 누락 | 401 UNAUTHORIZED |
| year 누락 | 현재 연도 대체 |
| 네트워크 오류 (자동 저장) | 오류 인디케이터 + 재시도 |
| 주일 아닌 날짜 클릭 | 출석 입력 허용 (행사 등) |

---

**작성일**: 2026-01-13
**수정일**: 2026-02-24 (문서 축약)
**작성자**: PM 에이전트
**상태**: Approved (구현 완료)

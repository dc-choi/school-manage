# PRD: 통계 졸업생 필터링

> SDD 작성자가 작성하는 제품 요구사항 문서입니다.
> 사업 에이전트의 `docs/business/` 문서를 기반으로 작성합니다.

## 배경/문제 요약

- 참고: `docs/specs/prd/statistics-snapshot.md`, `docs/specs/functional-design/statistics.md`
- 문제: 통계 조회 시 **졸업한 학생이 모든 연도에 포함**되어 현재 연도 통계가 부정확함
- 현재 상태:
  - 통계의 학생 수(분모) 계산이 `deletedAt: null` 조건만 사용
  - `graduatedAt` 필터링이 전혀 없음 → 2024년에 졸업한 학생이 2025, 2026년 통계에도 포함
  - 6개 통계 UseCase 전체에 동일한 문제 존재
  - 스냅샷 PRD에서 "졸업 학생 포함"을 명시했으나, 이는 **해당 학생이 활동했던 과거 연도**에 한정된 의미였음
- 목표 상태: 조회 기간 시작일 기준으로 통계 포함/제외를 판단하여 정확한 통계 제공

## 목표/성공 기준

- **목표**: 조회 기간 시작일을 기준으로 통계에서 학생을 적절히 포함/제외
- **성공 지표**:
  - 2026년 1월 졸업 학생 → 2026년 2월 조회 시 제외 (기간 시작 전 졸업)
  - 2025년 2월 졸업 학생 → 2025년 1월 조회 시 포함 (기간 시작 후 졸업)
  - 재학생은 모든 기간 통계에 정상 포함
- **측정 기간**: 배포 즉시 확인 가능

## 사용자/대상

- **주요 사용자**: 교리교사 (통계 조회, 사제 보고)
- **사용 맥락**: 현재 연도 통계 확인 시 졸업생이 포함되어 인원 수가 부풀려지는 문제

## 범위

### 포함

- 6개 통계 UseCase의 학생 수 계산에 `graduatedAt` 기반 연도 필터 적용
- 우수 출석 학생(raw SQL) 쿼리에도 동일 필터 적용

### 제외

- 스냅샷 생성/조회 로직 변경 (기존 유지)
- 프론트엔드 UI 변경 (기존 연도 선택 UI 유지)
- 졸업 처리 로직 변경 (기존 유지)

## 사용자 시나리오

1. **현재 연도 통계 조회**: 교리교사가 2026년 통계를 확인 → 졸업 처리된 학생이 제외되어 실제 재학생 기준 통계 표시
2. **과거 연도 통계 조회**: 교리교사가 2024년 통계를 확인 → 2024년에 졸업한 학생은 포함, 2023년 이전에 졸업한 학생은 제외
3. **졸업 직후 확인**: 교리교사가 학생을 졸업 처리한 뒤 현재 연도 통계 확인 → 해당 학생이 현재 연도 통계에는 아직 포함 (졸업 연도이므로)

## 요구사항

### 필수 (Must)

- [x] 학생 포함 조건: `graduatedAt IS NULL` OR `graduatedAt >= 조회_기간_시작일`
- [x] GetAttendanceRateUseCase: totalStudents 계산에 졸업 필터 적용
- [x] GetByGenderUseCase: 성별 학생 집계에 졸업 필터 적용
- [x] GetGroupStatisticsUseCase: 학년별 학생 수 계산에 졸업 필터 적용
- [x] GetTopGroupsUseCase: 학년별 출석률 학생 수에 졸업 필터 적용
- [x] GetExcellentStudentsUseCase: raw SQL에 졸업 필터 적용
- [x] GetTopOverallUseCase: raw SQL에 졸업 필터 적용

### 선택 (Should)

- [x] 통계 API 통합 테스트에 졸업 필터 검증 케이스 추가

### 제외 (Out)

- 프론트엔드 변경
- 스냅샷 로직 변경
- 대시보드 UI 변경

## 제약/가정/리스크

- **제약**: 기존 스냅샷 아키텍처 위에 필터만 추가 (구조 변경 없음)
- **가정**:
  - 졸업 시점은 본당마다 다름 (1월~2월 등), 따라서 연도가 아닌 조회 기간 시작일과 비교
  - 기간 시작일 전에 졸업한 학생은 해당 기간 통계에서 제외
- **리스크**: 없음 (단순 필터 추가)

## 의존성

- **내부**: Statistics 도메인 (6개 UseCase)
- **외부**: 없음

## 롤아웃/검증

- **출시 단계**: 단일 배포 (코드 변경만, DB 변경 없음)
- **이벤트/로그**: 없음
- **검증 방법**: 졸업 학생이 있는 계정에서 현재/과거 연도 통계 비교

## 오픈 이슈

- 없음

## 연결 문서

- PRD: `docs/specs/prd/statistics-snapshot.md`
- 기능 설계: `docs/specs/functional-design/statistics.md`
- 사업 문서: `docs/business/6_roadmap/roadmap.md`

---

**작성일**: 2026-02-24
**작성자**: SDD 작성자
**상태**: Approved (구현 완료)
